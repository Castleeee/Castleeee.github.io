<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>python进阶 | 会走路的三百块</title>
    <meta name="description" content="年轻人的博客">
    <link rel="icon" href="/logo1.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.d22626bb.css" as="style"><link rel="preload" href="/assets/js/app.64171550.js" as="script"><link rel="preload" href="/assets/js/68.3b9433a6.js" as="script"><link rel="preload" href="/assets/js/38.34e99c36.js" as="script"><link rel="prefetch" href="/assets/js/10.f30e4bf5.js"><link rel="prefetch" href="/assets/js/100.14a8b555.js"><link rel="prefetch" href="/assets/js/101.9e257240.js"><link rel="prefetch" href="/assets/js/11.c050169c.js"><link rel="prefetch" href="/assets/js/12.9abd0678.js"><link rel="prefetch" href="/assets/js/13.ca763ee5.js"><link rel="prefetch" href="/assets/js/14.69f05fca.js"><link rel="prefetch" href="/assets/js/15.db5225be.js"><link rel="prefetch" href="/assets/js/16.c6de58f6.js"><link rel="prefetch" href="/assets/js/17.a33727a2.js"><link rel="prefetch" href="/assets/js/18.78f0824a.js"><link rel="prefetch" href="/assets/js/19.20a4f3cf.js"><link rel="prefetch" href="/assets/js/20.15fb9aec.js"><link rel="prefetch" href="/assets/js/21.c2410e24.js"><link rel="prefetch" href="/assets/js/22.6423d49a.js"><link rel="prefetch" href="/assets/js/23.1b0b2120.js"><link rel="prefetch" href="/assets/js/24.93132bac.js"><link rel="prefetch" href="/assets/js/25.a334198a.js"><link rel="prefetch" href="/assets/js/26.c1c7aaa3.js"><link rel="prefetch" href="/assets/js/27.2c86a0cd.js"><link rel="prefetch" href="/assets/js/28.a9d5d0ae.js"><link rel="prefetch" href="/assets/js/29.82f2e489.js"><link rel="prefetch" href="/assets/js/3.465cd447.js"><link rel="prefetch" href="/assets/js/30.d0c8250c.js"><link rel="prefetch" href="/assets/js/31.e6286844.js"><link rel="prefetch" href="/assets/js/32.116769da.js"><link rel="prefetch" href="/assets/js/33.38e22b91.js"><link rel="prefetch" href="/assets/js/34.21d15ece.js"><link rel="prefetch" href="/assets/js/35.53517849.js"><link rel="prefetch" href="/assets/js/36.9b848dcf.js"><link rel="prefetch" href="/assets/js/37.bf3574bb.js"><link rel="prefetch" href="/assets/js/39.10a54121.js"><link rel="prefetch" href="/assets/js/4.9d750d27.js"><link rel="prefetch" href="/assets/js/40.0ead9dc2.js"><link rel="prefetch" href="/assets/js/41.16bfab2f.js"><link rel="prefetch" href="/assets/js/42.b0388f8b.js"><link rel="prefetch" href="/assets/js/43.1d51bbcb.js"><link rel="prefetch" href="/assets/js/44.9e15a8ac.js"><link rel="prefetch" href="/assets/js/45.c9a7ee30.js"><link rel="prefetch" href="/assets/js/46.0821d6b3.js"><link rel="prefetch" href="/assets/js/47.fdd4b2c4.js"><link rel="prefetch" href="/assets/js/48.c86a3241.js"><link rel="prefetch" href="/assets/js/49.29d7cdaf.js"><link rel="prefetch" href="/assets/js/5.b5540d72.js"><link rel="prefetch" href="/assets/js/50.88cae993.js"><link rel="prefetch" href="/assets/js/51.39b0672d.js"><link rel="prefetch" href="/assets/js/52.47b9c89c.js"><link rel="prefetch" href="/assets/js/53.561866dc.js"><link rel="prefetch" href="/assets/js/54.44ad8aef.js"><link rel="prefetch" href="/assets/js/55.999cd3f5.js"><link rel="prefetch" href="/assets/js/56.0fc25a14.js"><link rel="prefetch" href="/assets/js/57.fbeec51d.js"><link rel="prefetch" href="/assets/js/58.c2c3e960.js"><link rel="prefetch" href="/assets/js/59.388b8a2f.js"><link rel="prefetch" href="/assets/js/6.9305fa77.js"><link rel="prefetch" href="/assets/js/60.3bab7106.js"><link rel="prefetch" href="/assets/js/61.fab74e1f.js"><link rel="prefetch" href="/assets/js/62.b8451d9d.js"><link rel="prefetch" href="/assets/js/63.1ea19cc7.js"><link rel="prefetch" href="/assets/js/64.21f37b67.js"><link rel="prefetch" href="/assets/js/65.79da4678.js"><link rel="prefetch" href="/assets/js/66.2276f1ea.js"><link rel="prefetch" href="/assets/js/67.cf3e97e4.js"><link rel="prefetch" href="/assets/js/69.a6723b19.js"><link rel="prefetch" href="/assets/js/7.8235c05c.js"><link rel="prefetch" href="/assets/js/70.eff0cc02.js"><link rel="prefetch" href="/assets/js/71.577ad016.js"><link rel="prefetch" href="/assets/js/72.ee1b8084.js"><link rel="prefetch" href="/assets/js/73.ce23853b.js"><link rel="prefetch" href="/assets/js/74.e51d0dc7.js"><link rel="prefetch" href="/assets/js/75.3fbf6e41.js"><link rel="prefetch" href="/assets/js/76.1ad79723.js"><link rel="prefetch" href="/assets/js/77.05aaa2f4.js"><link rel="prefetch" href="/assets/js/78.9e4bf317.js"><link rel="prefetch" href="/assets/js/79.028f9c41.js"><link rel="prefetch" href="/assets/js/8.a4265244.js"><link rel="prefetch" href="/assets/js/80.a83e9fee.js"><link rel="prefetch" href="/assets/js/81.e20ef630.js"><link rel="prefetch" href="/assets/js/82.0a2c28d1.js"><link rel="prefetch" href="/assets/js/83.84f22d3a.js"><link rel="prefetch" href="/assets/js/84.8c0c443d.js"><link rel="prefetch" href="/assets/js/85.1473a2e2.js"><link rel="prefetch" href="/assets/js/86.4683653f.js"><link rel="prefetch" href="/assets/js/87.9507aa61.js"><link rel="prefetch" href="/assets/js/88.77ce595e.js"><link rel="prefetch" href="/assets/js/89.d25806a8.js"><link rel="prefetch" href="/assets/js/9.56b90d44.js"><link rel="prefetch" href="/assets/js/90.231b245f.js"><link rel="prefetch" href="/assets/js/91.cb1ec410.js"><link rel="prefetch" href="/assets/js/92.10cedbd9.js"><link rel="prefetch" href="/assets/js/93.575cc043.js"><link rel="prefetch" href="/assets/js/94.9233e13a.js"><link rel="prefetch" href="/assets/js/95.fafa9bc4.js"><link rel="prefetch" href="/assets/js/96.8b941223.js"><link rel="prefetch" href="/assets/js/97.49080105.js"><link rel="prefetch" href="/assets/js/98.82d1cc72.js"><link rel="prefetch" href="/assets/js/99.d78b0b9a.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.0cd5f832.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d22626bb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div><header id="navbarWrapper" class="navbar"><div class="sidebar-button"><i class="iconfont reco-menu"></i></div> <a href="/" class="home-link router-link-active"><img src="/head3.png" alt="会走路的三百块" class="logo"> <span class="site-name">会走路的三百块</span></a> <div class="links" style="max-width:nullpx;"><div class="side-search-wrapper"><div class="search-box" data-v-1b2e3b29><input aria-label="Search" autocomplete="off" spellcheck="false" value="" data-v-1b2e3b29> <i class="iconfont reco-search" data-v-1b2e3b29></i> <!----></div></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/backEnd.html" class="nav-link"><i class="iconfont undefined"></i>
  后端
</a></li><li class="dropdown-item"><!----> <a href="/categories/frontEnd.html" class="nav-link"><i class="iconfont undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/categories/bigData.html" class="nav-link"><i class="iconfont undefined"></i>
  大数据
</a></li><li class="dropdown-item"><!----> <a href="/categories/Distributed.html" class="nav-link"><i class="iconfont undefined"></i>
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/categories/life.html" class="nav-link"><i class="iconfont undefined"></i>
  日记
</a></li></ul></div></div><div class="nav-item"><a href="/tags/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tags
</a></div><div class="nav-item"><a href="/categories/article.html" class="nav-link"><i class="iconfont reco-up"></i>
  Library
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/about.html" class="nav-link"><i class="iconfont reco-account"></i>
  about me
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/04777e91e2ef" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-jianshu"></i>
  简书
  </a></div><div class="nav-item"><a href="https://github.com/Castleeee" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  </a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><div class="side-search-wrapper"><div class="search-box" data-v-1b2e3b29><input aria-label="Search" autocomplete="off" spellcheck="false" value="" data-v-1b2e3b29> <i class="iconfont reco-search" data-v-1b2e3b29></i> <!----></div></div> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/backEnd.html" class="nav-link"><i class="iconfont undefined"></i>
  后端
</a></li><li class="dropdown-item"><!----> <a href="/categories/frontEnd.html" class="nav-link"><i class="iconfont undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/categories/bigData.html" class="nav-link"><i class="iconfont undefined"></i>
  大数据
</a></li><li class="dropdown-item"><!----> <a href="/categories/Distributed.html" class="nav-link"><i class="iconfont undefined"></i>
  分布式
</a></li><li class="dropdown-item"><!----> <a href="/categories/life.html" class="nav-link"><i class="iconfont undefined"></i>
  日记
</a></li></ul></div></div><div class="nav-item"><a href="/tags/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tags
</a></div><div class="nav-item"><a href="/categories/article.html" class="nav-link"><i class="iconfont reco-up"></i>
  Library
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/about.html" class="nav-link"><i class="iconfont reco-account"></i>
  about me
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/04777e91e2ef" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-jianshu"></i>
  简书
  </a></div><div class="nav-item"><a href="https://github.com/Castleeee" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  </a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><!----></p> <ul class="sidebar-group-items"><li><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#python中一切皆对象" class="sidebar-link">python中一切皆对象</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#对象的产生" class="sidebar-link">对象的产生</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#python中不同的类型" class="sidebar-link">python中不同的类型</a></li></ul></li><li><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#魔法函数" class="sidebar-link">魔法函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#非数学运算类" class="sidebar-link">非数学运算类</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#数学运算类" class="sidebar-link">数学运算类</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#str-和-repr" class="sidebar-link">str 和 repr</a></li></ul></li><li><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#鸭子类型和python的多态性" class="sidebar-link">鸭子类型和python的多态性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#什么是鸭子" class="sidebar-link">什么是鸭子</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#抽象基类" class="sidebar-link">抽象基类</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#功能类mixin和变量机制" class="sidebar-link">功能类MixIn和变量机制</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#类方法和静态方法" class="sidebar-link">类方法和静态方法</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#自省机制" class="sidebar-link">自省机制</a></li></ul></li><li><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#基于协议的python" class="sidebar-link">基于协议的python</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#上下文管理协议" class="sidebar-link">上下文管理协议</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#序列相关协议" class="sidebar-link">序列相关协议</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#mapping类型协议" class="sidebar-link">Mapping类型协议</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#collections的用法" class="sidebar-link">collections的用法</a></li></ul></li><li><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#三神器" class="sidebar-link">三神器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#装饰器-留坑" class="sidebar-link">装饰器(留坑)</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#属性查找过程" class="sidebar-link">属性查找过程</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#迭代器" class="sidebar-link">迭代器</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#生成器" class="sidebar-link">生成器</a></li></ul></li><li><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#websocket" class="sidebar-link">WebSocket</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#基本的api" class="sidebar-link">基本的API</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#tcp-udp的使用代码" class="sidebar-link">TCP/UDP的使用代码</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#socketserver的使用" class="sidebar-link">socketserver的使用</a></li></ul></li><li><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#多线程" class="sidebar-link">多线程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#使用线程函数和线程类" class="sidebar-link">使用线程函数和线程类</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#线程安全队列" class="sidebar-link">线程安全队列</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#线程锁" class="sidebar-link">线程锁</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#条件变量" class="sidebar-link">条件变量</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#信号量" class="sidebar-link">信号量</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#线程池" class="sidebar-link">线程池</a></li></ul></li><li><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#多进程" class="sidebar-link">多进程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#进程池" class="sidebar-link">进程池</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#进程之间通信" class="sidebar-link">进程之间通信</a></li></ul></li><li><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#异步" class="sidebar-link">异步</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#异步基本概念" class="sidebar-link">异步基本概念</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#三种异步机制" class="sidebar-link">三种异步机制</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#asyncio生态" class="sidebar-link">asyncio生态</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#小总结" class="sidebar-link">小总结</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#async关键字" class="sidebar-link">async关键字</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#嵌套协程的返回机制" class="sidebar-link">嵌套协程的返回机制</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#在异步中使用同步代码" class="sidebar-link">在异步中使用同步代码</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#异步生命周期中的一些函数" class="sidebar-link">异步生命周期中的一些函数</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#异步中的锁" class="sidebar-link">异步中的锁</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#aio异步爬虫" class="sidebar-link">aio异步爬虫</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#异步插入数据库" class="sidebar-link">异步插入数据库</a></li></ul></li><li><a href="/blog/back/python/python%E8%BF%9B%E9%98%B6.html#后续将持续更新" class="sidebar-link">后续将持续更新</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page" data-v-cdcae5a4> <div class="page-title" data-v-cdcae5a4><h1 data-v-cdcae5a4>python进阶</h1> <hr data-v-cdcae5a4> <div data-v-2c25cede data-v-cdcae5a4><i class="iconfont reco-account" data-v-2c25cede><span data-v-2c25cede>会走路的三百块</span></i> <i class="iconfont reco-date" data-v-2c25cede><span data-v-2c25cede>12/28/2018</span></i> <!----> <i class="iconfont reco-tag tags" data-v-2c25cede><span class="tag-item" data-v-2c25cede>
      语言进阶
    </span><span class="tag-item" data-v-2c25cede>
      异步
    </span><span class="tag-item" data-v-2c25cede>
      python🐍
    </span><span class="tag-item" data-v-2c25cede>
      后端
    </span><span class="tag-item" data-v-2c25cede>
      所有文章
    </span></i></div></div> <div class="content" data-v-cdcae5a4><h2 id="python中一切皆对象"><a href="#python中一切皆对象" aria-hidden="true" class="header-anchor">#</a> python中一切皆对象</h2> <h3 id="对象的产生"><a href="#对象的产生" aria-hidden="true" class="header-anchor">#</a> 对象的产生</h3> <p>type-&gt;class-&gt;obj <br>
object是最高的父类，本身继承None <br></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><pre><code>type
</code></pre> <div class="language-python extra-class"><pre class="language-python"><code><span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span>
</code></pre></div><pre><code>type
</code></pre> <div class="language-python extra-class"><pre class="language-python"><code><span class="token builtin">type</span><span class="token punctuation">.</span>__base__
</code></pre></div><pre><code>object
</code></pre> <p>python中的对象有基本的三个特征：</p> <ul><li>id（身份）</li> <li>type（类型）</li> <li>value（值）</li></ul> <div class="language-python extra-class"><pre class="language-python"><code>a<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token builtin">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
</code></pre></div><pre><code>2296013674440
</code></pre> <div class="language-python extra-class"><pre class="language-python"><code><span class="token builtin">type</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
</code></pre></div><pre><code>list
</code></pre> <div class="language-python extra-class"><pre class="language-python"><code>a
</code></pre></div><pre><code>[]
</code></pre> <h3 id="python中不同的类型"><a href="#python中不同的类型" aria-hidden="true" class="header-anchor">#</a> python中不同的类型<br></h3> <div class="warning custom-block"><p class="custom-block-title">1</p> <p>None类型<br></p></div> <p>解释器刚开始运行就生成了一个None类型对象所有用到了None的地方指向的都是同一个全局的None</p> <div class="language-python extra-class"><pre class="language-python"><code>a<span class="token operator">=</span><span class="token boolean">None</span>
b<span class="token operator">=</span><span class="token boolean">None</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token operator">==</span><span class="token builtin">id</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
c<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
d<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token operator">==</span><span class="token builtin">id</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><pre><code>True
False
</code></pre> <div class="warning custom-block"><p class="custom-block-title">2</p> <p>数值类型 四种<br>
int float bool complex</p></div> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">print</span><span class="token punctuation">(</span>
<span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token builtin">type</span><span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token builtin">type</span><span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token builtin">type</span><span class="token punctuation">(</span><span class="token builtin">complex</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><pre><code>&lt;class 'int'&gt; &lt;class 'float'&gt; &lt;class 'bool'&gt; &lt;class 'complex'&gt;
</code></pre> <div class="warning custom-block"><p class="custom-block-title">3</p> <p>迭代类型</p></div> <p>可用for迭代的对象
实现了iter方法或者getitem方法的对象</p> <div class="warning custom-block"><p class="custom-block-title">4</p> <p>序列类型</p></div> <p>list<br>tuple<br> arry <br>str<br> range<br> bytes <br>bytearry <br> memoryview(二进制序列)    <br></p> <h4 id="其他类型"><a href="#其他类型" aria-hidden="true" class="header-anchor">#</a> 其他类型</h4> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>5 映射类型 k-v 字典，queryset等    <br>
6 集合类型set frozenset ，set和映射类型底层实现一致效率较高    <br>
7 上下文管理类型 with 语句所形成的类型    8 模块类型（package也是一种类型）    <br>
9 class和实例类型    <br>
10 函数类型    <br>
11 方法类型    <br>
12 代码类型（代码本身也会被解释为一种类型！！！）   <br>
13 object对象    <br>
14 type类型  <br>
15 ellipsis类型省略号类型？！    <br>
16 notimplemented类型就是类对象<br></p></div> <h2 id="魔法函数"><a href="#魔法函数" aria-hidden="true" class="header-anchor">#</a> 魔法函数</h2> <p>以双下划线开头结尾，具有特殊功能的函数 一般不要去自己定义，重载python提供给我们的即可<br></p> <p>python的数据模型是python底层实现机制重要的一环我们可以通过重载这些魔法函数来实现自己想要的功能<br></p> <p>先列出主要的魔法函数<br></p> <h3 id="非数学运算类"><a href="#非数学运算类" aria-hidden="true" class="header-anchor">#</a> 非数学运算类<br></h3> <pre><code>字符串表示：
    __repr__():

    __str__():

集合序列相关：
	__len__():
	__getitem__():
	__setitem__():
	__delitem__():
	__contains__():
迭代相关:
	__iter__():
	__next__():
可调用
	__call__():
with上下文管理器
	__enter__():
	__exit__():
数值转换
	__abs__():
	__bool__():
	__int__():
	__float__():
    __hash__():
    __index__():
元类相关
    __new__():
    __init__():
属性相关
	__getattr__():
	__setattr__():
	__getattribute__():
	__setattribute__():
	__dir__():
属性描述符
	__get__():
	__set__():
	__delete__():
协程
	__await__():
    __aiter__():
    __anext__():
    __aenter__():
    __aexit__():
</code></pre> <h3 id="数学运算类"><a href="#数学运算类" aria-hidden="true" class="header-anchor">#</a> 数学运算类</h3> <h4 id="略"><a href="#略" aria-hidden="true" class="header-anchor">#</a> 略</h4> <h3 id="str-和-repr"><a href="#str-和-repr" aria-hidden="true" class="header-anchor">#</a> str 和 repr</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">company</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>em<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>em<span class="token operator">=</span>em

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;employee:&quot;</span> <span class="token operator">+</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>em<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;开发者模式下不用打印就可以调用&quot;</span>

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>em<span class="token punctuation">)</span>
em<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;bobby&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;tom&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;bob&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;jhon&quot;</span><span class="token punctuation">]</span>
com<span class="token operator">=</span>company<span class="token punctuation">(</span>em<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>com<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;len的用法: &quot;</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>com<span class="token punctuation">)</span><span class="token punctuation">)</span>
com
</code></pre></div><pre><code>employee:bobby,tom,bob,jhon
len的用法:  4

开发者模式下不用打印就可以调用
</code></pre> <h4 id="str-self"><a href="#str-self" aria-hidden="true" class="header-anchor">#</a> _ <em>str</em> _(self):</h4> <p>在直接打印这个对象时就会调用该方法，若没有定义则会打印一些基本属性</p> <h4 id="repr-self"><a href="#repr-self" aria-hidden="true" class="header-anchor">#</a> _ <em>repr</em> _(self):</h4> <p>在开发者模式中直接调用这个对象则会调用repr方法<br>python内置的数据类型是用Cpython实现的，内置方法是C语言实现的效率会很高<br>
例如_ <em>len</em> _方法是在数据结构内维护一个长度，调用len的时候直接从内存读取会快很多<br>
for 对一个对象进行遍历的时候会先寻找iter方法，找不到会自动寻找getitem方法<br></p> <h2 id="鸭子类型和python的多态性"><a href="#鸭子类型和python的多态性" aria-hidden="true" class="header-anchor">#</a> 鸭子类型和python的多态性 <br></h2> <h3 id="什么是鸭子"><a href="#什么是鸭子" aria-hidden="true" class="header-anchor">#</a> 什么是鸭子</h3> <p>走路像鸭子叫声像鸭子长得像鸭子 那么就是鸭子。<br>
只要对象拥有这个特性那就是这个类型就可以调用相关的方法</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">say</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;hahaha...&quot;</span><span class="token punctuation">)</span>



<span class="token keyword">class</span> <span class="token class-name">Dog</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">say</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;15551&quot;</span><span class="token punctuation">)</span>

l<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
l<span class="token punctuation">.</span>append<span class="token punctuation">(</span>Dog<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
l<span class="token punctuation">.</span>append<span class="token punctuation">(</span>Cat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> l<span class="token punctuation">:</span>
    i<span class="token punctuation">.</span>say<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><pre><code>15551
hahaha...
</code></pre> <p>不同类型的对象只要拥有相同名字的方法就可以调用,传入对象的句柄(名字)即可</p> <div class="language-python extra-class"><pre class="language-python"><code>li<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>
se<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>

li<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>se<span class="token punctuation">)</span>
li
</code></pre></div><pre><code>[1, 2, 3, 4]
</code></pre> <p>只要是相同的基础数据类型（迭代类型，序列类型）方法可以混用<br>
_ <em>getitem</em> _：根据传入的int参数，返回一个列表中的元素</p> <p>_ <em>iter</em> _：返回一个可迭代对象</p> <p>_ <em>next</em> _：当被迭代时，返回下一个迭代的对象</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>n<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">&quot;it is string&quot;</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">yield</span> self<span class="token punctuation">.</span>n<span class="token punctuation">[</span>i<span class="token punctuation">]</span>


test<span class="token operator">=</span>Test<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>test<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> x <span class="token keyword">in</span> test<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token comment">#和下面是等价的，不过__iter__是返回一个可迭代对象，而iter()直接把这这个可迭代对象拿出来转换</span>
test1<span class="token operator">=</span><span class="token builtin">iter</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span>
<span class="token builtin">next</span><span class="token punctuation">(</span>test1<span class="token punctuation">)</span>
<span class="token builtin">next</span><span class="token punctuation">(</span>test1<span class="token punctuation">)</span>
<span class="token builtin">next</span><span class="token punctuation">(</span>test1<span class="token punctuation">)</span>
<span class="token builtin">next</span><span class="token punctuation">(</span>test1<span class="token punctuation">)</span>
<span class="token builtin">next</span><span class="token punctuation">(</span>test1<span class="token punctuation">)</span>

</code></pre></div><pre><code>i
it
it
it i
it is
it is
it is s
it is st
it is str
1
2
3
4



---------------------------------------------------------------------------

StopIteration                             Traceback (most recent call last)

&lt;ipython-input-52-1fe123b9197d&gt; in &lt;module&gt;()
     23 next(test1)
     24 next(test1)
---&gt; 25 next(test1)


StopIteration:
</code></pre> <p>next(x)=x.<strong>next</strong>,关于迭代有两个概念
<br>第一个是Iterable(可迭代对象)
<br>第二个是Iterator（迭代器）<br>
协议规定Iterable的__iter__方法会返回一个Iterator,<br>
Iterator的__next__方法会返回下一个迭代对象，如果迭代结束则抛出StopIteration异常。<br>iter(itr, 'c')  这个意思是说，返回itr的iterator，而且在之后的迭代之中，迭代出来'c'就立马停止。<br>对这个itr有什么要求呢？这个itr在这里必须是callable的，即要<br>实现__call__函数定义了__getitem__方法之后该对象就可以被下标和切片</p> <h3 id="抽象基类"><a href="#抽象基类" aria-hidden="true" class="header-anchor">#</a> 抽象基类</h3> <p><a href="https://blog.csdn.net/qijiqiguai/article/details/77269839">一个博主的详细介绍</a>
ABC，Abstract Base Class（抽象基类），主要定义了基本类和最基本的抽象方法，可以为子类定义共有的API，不需要具体实现。相当于是Java中的接口或者是抽象类。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">company</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>l<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>l<span class="token operator">=</span>l

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token number">5</span>

<span class="token keyword">from</span> collections <span class="token keyword">import</span> Sized
<span class="token comment">#对象是否有长度</span>
<span class="token builtin">isinstance</span><span class="token punctuation">(</span>company<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>Sized<span class="token punctuation">)</span>
<span class="token comment">#对象是否有某个属性，传入的是句柄</span>
<span class="token builtin">hasattr</span><span class="token punctuation">(</span>company<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">&quot;__len__&quot;</span><span class="token punctuation">)</span>
</code></pre></div><pre><code>True
</code></pre> <p>实现一个抽象基类最简单的方法就是在要做基类的类方法中抛出异常，使其必须重写这个方法</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">AbstractBase</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> NotImplementError

    <span class="token keyword">def</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> NotImplementError

<span class="token comment">#更优雅一些的方法</span>
<span class="token keyword">import</span> abc<span class="token comment">#自带的abc，可以做装饰器用</span>
<span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">(</span>metaclass<span class="token operator">=</span>abc<span class="token punctuation">.</span>ABCMeta<span class="token punctuation">)</span><span class="token punctuation">:</span>
    @abc<span class="token punctuation">.</span>abstractmethod
    <span class="token keyword">def</span> <span class="token function">my</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span>
A<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><pre><code>---------------------------------------------------------------------------

TypeError                                 Traceback (most recent call last)

&lt;ipython-input-59-dc359d224db9&gt; in &lt;module&gt;()
     12     def my(self):
     13         pass
---&gt; 14 A()


TypeError: Can't instantiate abstract class A with abstract methods my
</code></pre> <div class="danger custom-block"><p class="custom-block-title">其实有一点不太明白 留坑</p> <p>abc中强制规定了abstractmethod，继承时若不实现这一方法就无法实例化<br>
from collections.abc import *<br>
已经做好的一些基类可以拿来继承<br>
实现了__subclasshook__用于类型判断<br></p></div> <p>python的鸭子类型是根本,抽象基类可以给我们提供一些接口的强制规定和帮助我们自定义类型等等</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>


<span class="token keyword">class</span> <span class="token class-name">B</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>


b<span class="token operator">=</span>B<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token builtin">isinstance</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span>A<span class="token punctuation">)</span>
</code></pre></div><pre><code>True
</code></pre> <div class="danger custom-block"><p class="custom-block-title">is 和 ==不能混用</p> <p>is是判断是不是同一个对象通过id()的指向，而相等是判断值相等<br>isinstance判断对象是否在继承链的类型中</p></div> <h3 id="功能类mixin和变量机制"><a href="#功能类mixin和变量机制" aria-hidden="true" class="header-anchor">#</a> 功能类MixIn和变量机制</h3> <p>功能类，以MixIn命名结尾多继承关系中作为功能类继承，设计实现单一功能，相当于代替接口<br>
Mixin的特点<br>
和基类是弱相关或不相关<br>
Mixin功能单一<br>
不要使用Mixin的super<br></p> <h4 id="类变量和对象变量"><a href="#类变量和对象变量" aria-hidden="true" class="header-anchor">#</a> 类变量和对象变量</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    aa<span class="token operator">=</span><span class="token number">1</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#self 实在实例化的时候传递进来的实例本身</span>
        self<span class="token punctuation">.</span>x<span class="token operator">=</span>x
        self<span class="token punctuation">.</span>y<span class="token operator">=</span>y

a<span class="token operator">=</span>A<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
a<span class="token punctuation">.</span>aa<span class="token operator">=</span><span class="token number">100</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span>aa<span class="token punctuation">,</span>a<span class="token punctuation">.</span>x<span class="token punctuation">,</span>a<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>A<span class="token punctuation">.</span>aa<span class="token punctuation">)</span>
</code></pre></div><pre><code>100 2 3
1
</code></pre> <p>再调用的时候，会首先查找实例变量再去查找类变量<br>
在没有初始化a的时候存在一个A的类是一个类对象,实例化的时候成为一个类对象的实例<br>
对类实例进行赋值，会影响后续类对象，对类对象进行赋值，则只会影响本类对象<br>
python3中使用C3算法解决<a href="https://www.cnblogs.com/chenyoude/p/9857308.html">菱形继承</a><br></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>y<span class="token punctuation">,</span>m<span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>year<span class="token operator">=</span>y
        self<span class="token punctuation">.</span>month<span class="token operator">=</span>m
        self<span class="token punctuation">.</span>day<span class="token operator">=</span>d

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">r&quot;{0}/{1}/{2}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>year<span class="token punctuation">,</span>self<span class="token punctuation">.</span>month<span class="token punctuation">,</span>self<span class="token punctuation">.</span>day<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">tomorrow</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>day<span class="token operator">+=</span><span class="token number">1</span>


date<span class="token operator">=</span>Date<span class="token punctuation">(</span><span class="token number">2018</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span>
date<span class="token punctuation">.</span>tomorrow<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span>
</code></pre></div><pre><code>2018/3/4
2018/3/5
</code></pre> <div class="warning custom-block"><p class="custom-block-title">WARNING</p> <p>调用date.tomorrow()相当于tomorrow（date）<br>只会改变当前对象的属性，类属性应该写成Date.day+=1</p></div> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>y<span class="token punctuation">,</span>m<span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>year<span class="token operator">=</span>y
        self<span class="token punctuation">.</span>month<span class="token operator">=</span>m
        self<span class="token punctuation">.</span>day<span class="token operator">=</span>d

    <span class="token keyword">def</span> <span class="token function">__str__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">r&quot;{0}-{1}-{2}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>year<span class="token punctuation">,</span>self<span class="token punctuation">.</span>month<span class="token punctuation">,</span>self<span class="token punctuation">.</span>day<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">tomorrow</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>day<span class="token operator">+=</span><span class="token number">1</span>

    @<span class="token builtin">staticmethod</span>
    <span class="token keyword">def</span> <span class="token function">vaild</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">:</span>
        temp<span class="token operator">=</span>string<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> temp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;valited&quot;</span><span class="token punctuation">)</span>

    @<span class="token builtin">classmethod</span>
    <span class="token keyword">def</span> <span class="token function">dformat</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span>string<span class="token punctuation">)</span><span class="token punctuation">:</span>
        temp<span class="token operator">=</span>string<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;-&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            temp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>temp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">(</span>temp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>temp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>temp<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>


date<span class="token operator">=</span>Date<span class="token punctuation">(</span><span class="token number">2018</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>
string<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span>dformat<span class="token punctuation">(</span>string<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><pre><code>2018-3-4
</code></pre> <h3 id="类方法和静态方法"><a href="#类方法和静态方法" aria-hidden="true" class="header-anchor">#</a> 类方法和静态方法<br></h3> <p>静态方法一般是用来验证是否符合规范，不用再新建一个对象，而类方法可以直接返回实例对象</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    birthday<span class="token operator">=</span><span class="token number">1995</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>birthday<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>birthday<span class="token operator">=</span>birthday


<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Date<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>age<span class="token operator">=</span><span class="token number">2018</span><span class="token operator">-</span><span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>birthday

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>age<span class="token punctuation">)</span>


user<span class="token operator">=</span>User<span class="token punctuation">(</span><span class="token punctuation">)</span>
user
<span class="token keyword">print</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>__dict__<span class="token punctuation">,</span>User<span class="token punctuation">.</span>__dict__<span class="token punctuation">)</span>
</code></pre></div><pre><code>{'age': 23} {'__module__': '__main__', '__init__': &lt;function User.__init__ at 0x0000025EDB51DE18&gt;, '__repr__': &lt;function User.__repr__ at 0x0000025EDB5606A8&gt;, '__doc__': None}
</code></pre> <h3 id="自省机制"><a href="#自省机制" aria-hidden="true" class="header-anchor">#</a> 自省机制</h3> <p>__attr不能直接访问，相当于private，但也可_class__attr来访问<br>
__dict__可以直接下标访问是存贮属性的字典，也可以动态修改<br>
dir会把所有的属性特有的和基础的完整的列出来<br>
super函数是按照__mro__顺序来调用的，BFS，如果super有缺省可以直接让父类的构造函数来完成初始化<br>
Mixin的特点<br>
和基类是弱相关或不相关<br>
Mixin功能单一<br></p> <div class="warning custom-block"><p class="custom-block-title">WARNING</p> <p>不要使用Mixin的super<br></p></div> <div class="danger custom-block"><p class="custom-block-title">Try的堆栈</p> <p>python的try except和finally语句的return执行到error 时进入except 栈顶push 一个值，不返回，先运行finally语句再从栈顶拿出一个值pop</p></div> <h2 id="基于协议的python"><a href="#基于协议的python" aria-hidden="true" class="header-anchor">#</a> 基于协议的python</h2> <h3 id="上下文管理协议"><a href="#上下文管理协议" aria-hidden="true" class="header-anchor">#</a> 上下文管理协议</h3> <p>python是基于协议的运行,首先介绍上下文管理器的协议
也就是我们经常用的with</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Sample</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    S<span class="token operator">=</span><span class="token string">&quot;山口山&quot;</span>
    <span class="token keyword">def</span> <span class="token function">hah</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;aa&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;start&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>exc_type<span class="token punctuation">,</span>exc_val<span class="token punctuation">,</span>exc_tb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;end&quot;</span><span class="token punctuation">)</span>

    @<span class="token builtin">classmethod</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">gett</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> Sample<span class="token punctuation">(</span><span class="token punctuation">)</span>

a<span class="token operator">=</span>Sample<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># a.__dict__</span>
<span class="token comment"># dir(a)</span>
<span class="token keyword">with</span> gett<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> sample<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>sample<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token builtin">dir</span><span class="token punctuation">(</span>sample<span class="token punctuation">)</span>
    sample<span class="token punctuation">.</span>hah<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>sample<span class="token punctuation">.</span>S<span class="token punctuation">)</span>
</code></pre></div><pre><code>start
&lt;class 'NoneType'&gt;
end



---------------------------------------------------------------------------

AttributeError                            Traceback (most recent call last)

&lt;ipython-input-172-7d068effdd73&gt; in &lt;module&gt;()
     23     print(type(sample))
     24     dir(sample)
---&gt; 25     sample.hah()
     26     print(sample.S)


AttributeError: 'NoneType' object has no attribute 'hah'
</code></pre> <p>具体可控的上下文管理协议</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> contextlib

@contextlib<span class="token punctuation">.</span>contextmanager
<span class="token keyword">def</span> <span class="token function">p</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;前操作&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">yield</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;后操作&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> p<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pp<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;中间的操作&quot;</span><span class="token punctuation">)</span>
</code></pre></div><pre><code>前操作
中间的操作
后操作
</code></pre> <h3 id="序列相关协议"><a href="#序列相关协议" aria-hidden="true" class="header-anchor">#</a> 序列相关协议</h3> <p>序列 <br>容器序列 <br>扁平序列 <br>可变/不可变<br>
在 collections abc中有两个抽象基类:<br> Squence MutableSequence序列和多对象序列<br></p> <p>Sequence序列类继承了<br>{
    Reversible可反转，<br>
    Collection继承了{<br>
        Sized长度<br>
        Iterable可迭代<br>
        Container容器{<br>
           的absctactmethod <strong>contains__负责is以以及__setitem</strong> <strong>delitem</strong>}}}}</p> <h4 id="在序列中-extend的区别"><a href="#在序列中-extend的区别" aria-hidden="true" class="header-anchor">#</a> 在序列中+ += extend的区别</h4> <div class="language-python extra-class"><pre class="language-python"><code>a<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>
c<span class="token operator">=</span>a<span class="token operator">+</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span>
c<span class="token operator">+=</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span>
c
</code></pre></div><pre><code>[1, 2, 3, 4, 5, 6]
</code></pre> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>+=实际上时abc中的__iadd__调用的时extend -&gt;执行for 循环一个个append到序列中<br>所以可以接受一个序列即可，在原序列中直接加<br>而+是产生一个新的序列
<br>切片操作是会返回一个新的列表</p></div> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Group</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>groupname<span class="token punctuation">,</span>companyname<span class="token punctuation">,</span>member<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>group_name <span class="token operator">=</span> groupname
        self<span class="token punctuation">.</span>company <span class="token operator">=</span> companyname
        self<span class="token punctuation">.</span>member <span class="token operator">=</span> member
    <span class="token keyword">def</span> <span class="token function">__reversed__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span><span class="token comment">#自行解决</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">:</span>
        cls<span class="token operator">=</span><span class="token builtin">type</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">isinstance</span> <span class="token punctuation">(</span>item<span class="token punctuation">,</span><span class="token builtin">slice</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> cls<span class="token punctuation">(</span>group_name<span class="token operator">=</span>self<span class="token punctuation">.</span>group_name<span class="token punctuation">,</span>companyname<span class="token operator">=</span>self<span class="token punctuation">.</span>company<span class="token punctuation">,</span>member<span class="token operator">=</span>self<span class="token punctuation">.</span>member<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span>numbers<span class="token punctuation">.</span>Integral<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> cls<span class="token punctuation">(</span>group_name<span class="token operator">=</span>self<span class="token punctuation">.</span>group_name<span class="token punctuation">,</span>companyname<span class="token operator">=</span>self<span class="token punctuation">.</span>company<span class="token punctuation">,</span>member<span class="token operator">=</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>member<span class="token punctuation">[</span>item<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment">#切片slice对象和item是重点</span>

    <span class="token keyword">def</span> <span class="token function">__iter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">pass</span><span class="token comment">#自行解决</span>

    <span class="token keyword">def</span> <span class="token function">__contains__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>item<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> item <span class="token keyword">in</span> self<span class="token punctuation">.</span>member<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
        <span class="token comment"># 用if 来解决 in</span>
</code></pre></div><h4 id="维护一个已排序的序列"><a href="#维护一个已排序的序列" aria-hidden="true" class="header-anchor">#</a> 维护一个已排序的序列</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> bisect

<span class="token comment">#your class&amp;function here</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    l<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    bisect<span class="token punctuation">.</span>insort<span class="token punctuation">(</span>l<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
    bisect<span class="token punctuation">.</span>insort<span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
    bisect<span class="token punctuation">.</span>insort<span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
    bisect<span class="token punctuation">.</span>insort<span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>
    bisect<span class="token punctuation">.</span>insort<span class="token punctuation">(</span>l<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>
    bisect<span class="token punctuation">.</span>insort_left<span class="token punctuation">(</span>l<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span>
    bisect<span class="token punctuation">.</span>insort_right<span class="token punctuation">(</span>l<span class="token punctuation">,</span><span class="token number">2.9</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>
</code></pre></div><pre><code>[1, 2, 3, 5, 6]
[1, 2, 2.9, 3, 5, 5, 6]
</code></pre> <p>arr留坑</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> arry
<span class="token keyword">from</span> collections <span class="token keyword">import</span> deque

</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>列表生成式性能是高于列表普通操作的，可以用函数来进行操作</p></div> <div class="language-python extra-class"><pre class="language-python"><code>    <span class="token keyword">def</span> <span class="token function">x</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token operator">*</span>y<span class="token comment">#返回值会被添加进列表中</span>
    l<span class="token operator">=</span><span class="token punctuation">[</span>x<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> l <span class="token keyword">if</span> i <span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">]</span>
    l1<span class="token operator">=</span><span class="token punctuation">(</span>x<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> l <span class="token keyword">if</span> i <span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token builtin">type</span><span class="token punctuation">(</span>l1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#生成器表达式</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span>l1<span class="token punctuation">)</span>
    dic<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">:</span><span class="token number">56</span><span class="token punctuation">,</span><span class="token string">&quot;c&quot;</span><span class="token punctuation">:</span><span class="token number">88</span><span class="token punctuation">}</span>
    reverseddic<span class="token operator">=</span><span class="token punctuation">{</span>v<span class="token punctuation">:</span>k <span class="token keyword">for</span> k<span class="token punctuation">,</span>v <span class="token keyword">in</span> dic<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>reverseddic<span class="token punctuation">)</span><span class="token comment">#键值对反转</span>
</code></pre></div><h3 id="mapping类型协议"><a href="#mapping类型协议" aria-hidden="true" class="header-anchor">#</a> Mapping类型协议</h3> <h4 id="dict"><a href="#dict" aria-hidden="true" class="header-anchor">#</a> dict</h4> <p>dict是一个典型Mapping类型，abc继承关系是<br>
-Container as Container,<br>
-Hashable as Hashable,<br>
-Iterable as Iterable,<br>
Iterator as Iterator,<br>
-Sized as Sized,<br>
Callable as Callable,<br>
-Mapping as Mapping,<br>
MutableMapping as MutableMapping,<br>
Sequence as Sequence,<br>
MutableSequence as MutableSequence,<br>
Set as Set,<br>
MutableSet as MutableSet,<br>
MappingView as MappingView,<br>
ItemsView as ItemsView,<br>
KeysView as KeysView,<br>
ValuesView as ValuesView,<br></p> <div class="warning custom-block"><p class="custom-block-title">copy</p> <p>深拷贝改变拷贝对象不会改变原对象，只要拷贝的对象是非容器类型（比如字符串，数字和其他原子类型）就不能进行拷贝而是添加引用</p></div> <p>这是代码</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> copy
a<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
b<span class="token operator">=</span>a
c<span class="token operator">=</span>a<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#浅拷贝,复制了一个其他对象，但是不会把字典中的字典和列表进行修改</span>
d<span class="token operator">=</span>copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token comment">#深拷贝，递归复制</span>
b<span class="token punctuation">[</span><span class="token string">&quot;c&quot;</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">5</span>
c<span class="token punctuation">[</span><span class="token string">&quot;d&quot;</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">6</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">,</span>d<span class="token punctuation">)</span>
</code></pre></div><pre><code>{'c': 5} {'c': 5} {'c': 6} {}
</code></pre> <p>yuan</p> <h4 id="dict用法补充"><a href="#dict用法补充" aria-hidden="true" class="header-anchor">#</a> dict用法补充</h4> <div class="language-python extra-class"><pre class="language-python"><code>a<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;c&quot;</span><span class="token punctuation">]</span>
dic<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
dic<span class="token punctuation">.</span>fromkeys<span class="token punctuation">(</span>a<span class="token punctuation">,</span><span class="token string">&quot;沙雕牛肉&quot;</span><span class="token punctuation">)</span><span class="token comment">#传入一个 可迭代对象，默认值 生成字典</span>
dic<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&quot;想取的索引&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;取不到就返回的默认值&quot;</span><span class="token punctuation">)</span>
dic<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">&quot;索引&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;值&quot;</span><span class="token punctuation">)</span><span class="token comment">#先添加或更改一个键值对，然后取出</span>
dic<span class="token punctuation">.</span>update<span class="token punctuation">(</span>Iterable<span class="token punctuation">)</span><span class="token comment">#将这个可迭代对象一般是键值对形式添加到字典中去，[(a,b),(c,d)] a=b,c=d {&quot;a&quot;:&quot;b&quot;,&quot;c&quot;:&quot;d&quot;}</span>
</code></pre></div><pre><code>'默认值'
</code></pre> <div class="danger custom-block"><p class="custom-block-title">原生结构</p> <p>python原生的一些数据结构list dict等等直接继承在某些情况下不会生效<br>
最好继承collections UserDict，list同理</p></div> <h4 id="set的用法补充"><a href="#set的用法补充" aria-hidden="true" class="header-anchor">#</a> set的用法补充</h4> <p>set是一个无序不重复集合修改用add（）del（）pop（）等等，frozenset是不可变集合，无法修改但是可以作为dict的key</p> <div class="language-python extra-class"><pre class="language-python"><code>s<span class="token operator">=</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">&quot;def&quot;</span><span class="token punctuation">)</span><span class="token comment">#会把迭代对象分别作为元素</span>
s<span class="token punctuation">.</span>add<span class="token punctuation">(</span><span class="token string">&quot;abc&quot;</span><span class="token punctuation">)</span><span class="token comment">#直接添加</span>
s<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token string">&quot;abc&quot;</span><span class="token punctuation">)</span><span class="token comment">#会把迭代对象分别作为元素</span>
d<span class="token operator">=</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">&quot;defgh&quot;</span><span class="token punctuation">)</span>
s<span class="token punctuation">.</span>difference<span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token comment">#比较两个set的不同，取差集，是一个新的set，主要的操作 |并 &amp;交 -差</span>
</code></pre></div><pre><code>{'a', 'abc', 'b', 'c'}
</code></pre> <div class="tip custom-block"><p class="custom-block-title">垃圾回收</p> <p>python中的垃圾回收算法是引用计数，一个变量有n个引用，当引用计数变为 0 即回收垃圾，del函数可完成更高级的垃圾回收
参数绝对不能用可变对象（list）
注意环形引用问题</p></div> <h3 id="collections的用法"><a href="#collections的用法" aria-hidden="true" class="header-anchor">#</a> collections的用法</h3> <h4 id="关于queue-dequeue-counter-partial-chainmap-namedtuple-defaultdict-chain"><a href="#关于queue-dequeue-counter-partial-chainmap-namedtuple-defaultdict-chain" aria-hidden="true" class="header-anchor">#</a> 关于queue dequeue Counter partial ChainMap namedtuple defaultdict Chain</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#-*-coding:utf-8-*-</span>
<span class="token comment">#SettingCode here</span>
__author__ <span class="token operator">=</span> <span class="token string">&quot;a_little_rubbish&quot;</span>
__date__ <span class="token operator">=</span> <span class="token string">&quot;2018/11/23 16:34&quot;</span>

<span class="token comment">#import your model here</span>
<span class="token keyword">import</span> collections
<span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple<span class="token punctuation">,</span>defaultdict<span class="token punctuation">,</span>deque<span class="token punctuation">,</span>Counter<span class="token punctuation">,</span>ChainMap
<span class="token keyword">from</span> functools <span class="token keyword">import</span> partial<span class="token comment">#包裹函数返回句柄</span>
<span class="token keyword">from</span> itertools <span class="token keyword">import</span> chain<span class="token comment">#传入好几个可迭代一块迭代</span>
<span class="token keyword">from</span> pprint <span class="token keyword">import</span> pprint<span class="token comment">#漂亮打印</span>
<span class="token keyword">from</span> copy <span class="token keyword">import</span> deepcopy<span class="token comment">#深拷贝</span>
<span class="token comment">#your class&amp;function here</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    tup<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;c&quot;</span><span class="token punctuation">)</span><span class="token comment">#tuple是不可变对象，有序</span>
    a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token operator">=</span>tup<span class="token comment">#可以直接拆包</span>
    d<span class="token punctuation">,</span><span class="token operator">*</span>other<span class="token operator">=</span>tup<span class="token comment">#d是第一个元素，其他的不管了</span>
    <span class="token comment">#c语言中tuple是struct而list却是arry，tuple在编译的时候就确定，性能强，可作为dic的key，不可变-&gt;可哈希</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">,</span>c<span class="token punctuation">,</span>d<span class="token punctuation">)</span>
<span class="token comment">#namedtuple的用法</span>
    dic<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">:</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token string">&quot;country&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;china&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;height&quot;</span><span class="token punctuation">:</span><span class="token number">165</span><span class="token punctuation">,</span><span class="token string">&quot;edu&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;master&quot;</span><span class="token punctuation">}</span>
    User<span class="token operator">=</span>namedtuple<span class="token punctuation">(</span><span class="token string">&quot;User&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;country&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;height&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;edu&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#会给你创建一个类，类名加属性列表</span>
    user<span class="token operator">=</span>User<span class="token punctuation">(</span>age<span class="token operator">=</span><span class="token number">23</span><span class="token punctuation">,</span>country<span class="token operator">=</span><span class="token string">&quot;china&quot;</span><span class="token punctuation">,</span>height<span class="token operator">=</span><span class="token number">165</span><span class="token punctuation">,</span>edu<span class="token operator">=</span><span class="token string">&quot;mm&quot;</span><span class="token punctuation">)</span><span class="token comment">#可以按属性名实例化，并且属性名不可变</span>
    f<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token string">&quot;china&quot;</span><span class="token punctuation">,</span><span class="token number">165</span><span class="token punctuation">)</span>
    user2<span class="token operator">=</span>User<span class="token punctuation">(</span><span class="token operator">*</span>f<span class="token punctuation">,</span><span class="token string">&quot;muster&quot;</span><span class="token punctuation">)</span><span class="token comment">#和上面初始化是一样,并且额外传入了了master这个属性</span>
    <span class="token comment">#从数据库里拿出来少了一列的话可以直接加上</span>
    user3<span class="token operator">=</span>User<span class="token punctuation">(</span><span class="token operator">**</span>dic<span class="token punctuation">)</span><span class="token comment">#用字典实例化</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>user3<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;age is :&quot;</span><span class="token punctuation">,</span>user2<span class="token punctuation">.</span>age<span class="token punctuation">)</span><span class="token comment">#省空间，内存和消耗小，参数就是用tuple完成的</span>
    <span class="token keyword">exec</span><span class="token punctuation">(</span><span class="token string">&quot;print('hello')&quot;</span><span class="token punctuation">)</span><span class="token comment">#执行代码</span>
<span class="token comment">#defualtdict的用法,c写的,还有setdefault</span>
dic<span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'runoob'</span><span class="token punctuation">:</span> <span class="token string">'菜鸟'</span><span class="token punctuation">,</span> <span class="token string">'google'</span><span class="token punctuation">:</span> <span class="token string">'Google 搜索'</span><span class="token punctuation">}</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Value : %s&quot;</span> <span class="token operator">%</span> dic<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">'runoob'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#调用setdefault的时候，找不到就返回这个default值</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Value : %s&quot;</span> <span class="token operator">%</span> dic<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">'Taobao'</span><span class="token punctuation">,</span> <span class="token string">'淘宝'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">de</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">:</span><span class="token string">&quot;booon&quot;</span><span class="token punctuation">}</span>
d<span class="token operator">=</span>defaultdict<span class="token punctuation">(</span>de<span class="token punctuation">)</span><span class="token comment">#传入一个可调用对象，如果字典没有找到你要的🗡，就给你新建一个键值为对象的返回值,可用函数包装一下</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">&quot;apple&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;sansum&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;HP&quot;</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token comment">#int默认为0,list默认空字典</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>d<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">#deque双端队列</span>
x<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">]</span>
q<span class="token operator">=</span>deque<span class="token punctuation">(</span>x<span class="token punctuation">,</span>maxlen<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token comment">#可迭代对象，最大长度</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span>
q<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#清空</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span>
q<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token comment">#添加对象</span>
q<span class="token punctuation">.</span>appendleft<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#向左端添加对象</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#返回6出现的次数</span>
q1<span class="token operator">=</span>q<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#浅拷贝</span>
q2<span class="token operator">=</span>deepcopy<span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token comment">#深拷贝</span>
q<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>q1<span class="token punctuation">)</span><span class="token comment">#合并，直接在原来deque操作，不会返回新的</span>
q<span class="token punctuation">.</span>extendleft<span class="token punctuation">(</span>q1<span class="token punctuation">)</span><span class="token comment">#从左边合并，直接在原来deque操作，不会返回新的</span>
q<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">&quot;xxx&quot;</span><span class="token punctuation">)</span><span class="token comment">#在下标为3地方插入</span>
q<span class="token punctuation">.</span>reverse<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#翻转</span>
q<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#返回最后一个并删除</span>
q<span class="token punctuation">.</span>popleft<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#返回最左边的一个并删除</span>
q<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token comment">#在0-5下标之间查找6</span>
<span class="token comment">#Counter的使用</span>
a<span class="token operator">=</span><span class="token string">&quot;sadbsdvfbdjfbdksdv&quot;</span>
s<span class="token operator">=</span>Counter<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token comment">#传入一个可迭代对象字符串列表什么的，统计元素出现次数</span>
s1<span class="token operator">=</span>Counter<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
s<span class="token punctuation">.</span>update<span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token comment">#把两个Counter加起来</span>
pprint<span class="token punctuation">(</span>s<span class="token punctuation">.</span>most_common<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#最多次数的俩，是列表</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> ChainMap<span class="token punctuation">(</span>s<span class="token punctuation">,</span>s1<span class="token punctuation">)</span><span class="token punctuation">:</span>
    pprint<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token comment">#把俩字典合成Chainmap对象，但是不是加在一起了，迭代的时候前面出现的元素后面不会在打印</span>

</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>接下来的代码会很多我在PyCharm里面写然后复制过来</p></div> <h2 id="三神器"><a href="#三神器" aria-hidden="true" class="header-anchor">#</a> 三神器</h2> <h3 id="装饰器-留坑"><a href="#装饰器-留坑" aria-hidden="true" class="header-anchor">#</a> 装饰器(留坑)</h3> <p>自定义get set方法</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token decorator annotation punctuation">@property</span>
@被装饰的类<span class="token punctuation">.</span>setter
@被装饰的类<span class="token punctuation">.</span>getter
</code></pre></div><h3 id="属性查找过程"><a href="#属性查找过程" aria-hidden="true" class="header-anchor">#</a> 属性查找过程</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>birth<span class="token punctuation">,</span>day<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>birth<span class="token operator">=</span>birth
        self<span class="token punctuation">.</span>day<span class="token operator">=</span>day

    <span class="token keyword">def</span> <span class="token function">__getattr__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>item<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#找不到属性的时候会进入这个函数</span>
        <span class="token keyword">return</span> <span class="token string">&quot;没发现&quot;</span><span class="token operator">+</span>item

    <span class="token keyword">def</span> <span class="token function">__getattribute__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>item<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#只要查找属性就会进入这里</span>
        <span class="token keyword">return</span> <span class="token string">&quot;发现了&quot;</span><span class="token operator">+</span>item

a<span class="token operator">=</span>A<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span>
a<span class="token punctuation">.</span>name
</code></pre></div><pre><code>'发现了name'
</code></pre> <p>使用属性描述符限制传值的类型，参考Django的form验证<br>
如果user是某个类的实例，那么user.age 以及等价的getattr(user,age)<br></p> <ul><li><p>首先调用__getattribute__。如果类定义了 __getattr__方法，<br></p></li> <li><p>那么在____getattribute__拋出AttributeError的时候就会调用到__getattr__，<br></p></li></ul> <p>而对于描述符(<strong>get</strong>)的调用，则是发生在__getattribute__内部的<br></p> <p>user = User(),那么user.age 顺序如下：<br></p> <ol><li>E3果“”是出现在User或其基类的__diet__中，且age是data descriptor，<br></li> <li>如果“age”出现在obj的__diet__中，那么直接返回obj.<strong>diet</strong>[fage’],<br></li> <li>如果“age”出现在User或其基类的__dict__*<br> <ul><li>如果age是non-data descriptor,那么调用其__get__方 法 ， 否 则<br></li> <li>返回 <strong>dict</strong>[fage’]<br></li></ul></li> <li>如果User有__getattr__方法，调用__getattr__方法，否则<br></li> <li>抛出AttributeError<br></li></ol> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__new__</span><span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#代表本类</span>
        <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">.</span>__new__<span class="token punctuation">(</span>cls<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#代表本对象</span>

</code></pre></div><pre><code>  File &quot;&lt;ipython-input-2-00e9d8750bd0&gt;&quot;, line 5

    ^
SyntaxError: unexpected EOF while parsing
</code></pre> <div class="tip custom-block"><p class="custom-block-title">new和init</p> <p>new是用来自定义类产生过程的逻辑<br>init是用来定义实例产生的过程的<br>
如果new没有返回对象，则不会进入实例化阶段</p></div> <h3 id="迭代器"><a href="#迭代器" aria-hidden="true" class="header-anchor">#</a> 迭代器</h3> <h4 id="迭代器是实现的迭代协议"><a href="#迭代器是实现的迭代协议" aria-hidden="true" class="header-anchor">#</a> 迭代器是实现的迭代协议</h4> <p>无法下标访问（getitem）不直接返回，惰性返回数据的方式<br>iterable-&gt; iter函数 和tierator-&gt;netx函数 <br>
实际访问通过的是next</p> <h3 id="生成器"><a href="#生成器" aria-hidden="true" class="header-anchor">#</a> 生成器</h3> <h4 id="只要是含有yield的就是生成器"><a href="#只要是含有yield的就是生成器" aria-hidden="true" class="header-anchor">#</a> 只要是含有yield的就是生成器</h4> <p>提供了惰性求值<br>
python—切皆对象，栈帧对象，字节码对象<br>
当foo调用子函数bar，又士创建一个栈帧<br>
所有的栈帧都是分配在堆内存上，这就决定了栈帧可以独立于调用者存在<br>
静态语言是放到栈上运行完毕之后会销毁<br>动态语言放在堆上，找到栈帧可以持续调用<br></p> <p><img src="https://upload-images.jianshu.io/upload_images/12620393-3e2b72fd6678a24b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="栈帧字节码"></p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>原生过程是将递归之后的字节码都压到栈帧里去，然后函数的指针指向最近一次运行的栈帧，运行之后就会执行下一个栈帧所以可以顺利的yield</p></div> <p><img src="https://upload-images.jianshu.io/upload_images/12620393-401946d7f7695b32.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="栈帧"></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#-*-coding:utf-8-*-</span>
<span class="token comment">#SettingCode here</span>
__author__ <span class="token operator">=</span> <span class="token string">&quot;a_little_rubbish&quot;</span>
__date__ <span class="token operator">=</span> <span class="token string">&quot;10/12/2018 3:51 PM&quot;</span>

<span class="token comment">#import your model here</span>
<span class="token keyword">import</span> dis
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> collections<span class="token punctuation">.</span>abc <span class="token keyword">import</span> Mapping<span class="token punctuation">,</span>MutableMapping
<span class="token comment">#your class&amp;function here</span>
<span class="token keyword">def</span> <span class="token function">generat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">yield</span> <span class="token number">1</span>
    s<span class="token operator">=</span><span class="token string">&quot;我是s&quot;</span>
    <span class="token keyword">yield</span> <span class="token number">2</span>
    m <span class="token operator">=</span> <span class="token string">&quot;我是m&quot;</span>
    <span class="token keyword">yield</span> <span class="token number">3</span>

<span class="token keyword">def</span> <span class="token function">gen_fib</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    n<span class="token punctuation">,</span>f0<span class="token punctuation">,</span>f1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span>
    <span class="token keyword">while</span> n<span class="token operator">&lt;=</span>index<span class="token punctuation">:</span>
        f0<span class="token punctuation">,</span>f1<span class="token operator">=</span>f1<span class="token punctuation">,</span>f1<span class="token operator">+</span>f0
        <span class="token keyword">yield</span> f0
        n<span class="token operator">+=</span><span class="token number">1</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    ge<span class="token operator">=</span>generat<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>dis<span class="token punctuation">.</span>dis<span class="token punctuation">(</span>ge<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ge<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_lasti<span class="token punctuation">)</span><span class="token comment">#最后指向栈帧的指针</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ge<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_locals<span class="token punctuation">)</span><span class="token comment">#本地变量</span>
    <span class="token builtin">next</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ge<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_lasti<span class="token punctuation">)</span><span class="token comment">#最后指向栈帧的指针</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ge<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_locals<span class="token punctuation">)</span><span class="token comment">#本地变量</span>
    <span class="token builtin">next</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ge<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_lasti<span class="token punctuation">)</span><span class="token comment">#最后指向栈帧的指针</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ge<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_locals<span class="token punctuation">)</span><span class="token comment">#本地变量</span>
    <span class="token builtin">next</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ge<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_lasti<span class="token punctuation">)</span><span class="token comment">#最后指向栈帧的指针</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ge<span class="token punctuation">.</span>gi_frame<span class="token punctuation">.</span>f_locals<span class="token punctuation">)</span><span class="token comment">#本地变量</span>
    <span class="token builtin">next</span><span class="token punctuation">(</span>ge<span class="token punctuation">)</span>
    <span class="token comment"># for i in ge:</span>
    <span class="token comment">#     print(i)</span>
    <span class="token comment"># for i in gen_fib(50):</span>
    <span class="token comment">#     print(i)</span>
</code></pre></div><pre><code> 12           0 LOAD_CONST               1 (1)
              2 YIELD_VALUE
              4 POP_TOP

 13           6 LOAD_CONST               2 ('我是s')
              8 STORE_FAST               0 (s)

 14          10 LOAD_CONST               3 (2)
             12 YIELD_VALUE
             14 POP_TOP

 15          16 LOAD_CONST               4 ('我是m')
             18 STORE_FAST               1 (m)

 16          20 LOAD_CONST               5 (3)
             22 YIELD_VALUE
             24 POP_TOP
             26 LOAD_CONST               0 (None)
             28 RETURN_VALUE
None
-1
{}
2
{}
12
{'s': '我是s'}
22
{'s': '我是s', 'm': '我是m'}



---------------------------------------------------------------------------

StopIteration                             Traceback (most recent call last)

&lt;ipython-input-9-c12afe8f7bdb&gt; in &lt;module&gt;()
     37     print(ge.gi_frame.f_lasti)#最后指向栈帧的指针
     38     print(ge.gi_frame.f_locals)#本地变量
---&gt; 39     next(ge)
     40     # for i in ge:
     41     #     print(i)


StopIteration:
</code></pre> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#### 读取一行超大文件有分隔符</span>
超大一行文件<span class="token punctuation">,</span>不能直接read<span class="token punctuation">,</span>readline也不行因为只有一行<span class="token punctuation">,</span>内存会爆掉
<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>tip
使用迭代器惰性返回<span class="token punctuation">,</span>设置<span class="token builtin">buffer</span>代码如下
<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">:</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>
<span class="token keyword">def</span> <span class="token function">myreadlines</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span>newline<span class="token punctuation">)</span><span class="token punctuation">:</span>
    buf<span class="token operator">=</span><span class="token string">&quot;&quot;</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> newline <span class="token keyword">in</span> buf <span class="token punctuation">:</span>
            pos<span class="token operator">=</span>buf<span class="token punctuation">.</span>index<span class="token punctuation">(</span>newline<span class="token punctuation">)</span>
            <span class="token keyword">yield</span> buf<span class="token punctuation">[</span><span class="token punctuation">:</span>pos<span class="token punctuation">]</span>
            buf<span class="token operator">=</span>buf<span class="token punctuation">[</span>pos<span class="token operator">+</span><span class="token builtin">len</span><span class="token punctuation">(</span>newline<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
        chunk<span class="token operator">=</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> chunk<span class="token punctuation">:</span>
            <span class="token keyword">yield</span> buf
            <span class="token keyword">break</span>
        buf<span class="token operator">+=</span>chunk

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">&quot;./files/a.txt&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;r&quot;</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> myreadlines<span class="token punctuation">(</span>f<span class="token punctuation">,</span><span class="token string">&quot;|&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
</code></pre></div><pre><code>sdfghRSXCSYDVASYEDCRAVSBWDYGT
exrsadcsvydbasfygv7aysdsaidbas9dunb
shdvgyascvdtysacdysgbdyuasfvy
dsfvgyasuvbdas87fydvasyfvi
dvfysaded7ftv7sadybs
sdyfb87dygvfds7ybnfufvwb8dfvbe6tvdb8uvfwy8duiygwdf
sedfuwyiyfrte7y8urgevtfbyefb7vyd8unedyb8
edyundimgrfey8unimdgrvyb8unwime
</code></pre> <h2 id="websocket"><a href="#websocket" aria-hidden="true" class="header-anchor">#</a> WebSocket</h2> <h3 id="基本的api"><a href="#基本的api" aria-hidden="true" class="header-anchor">#</a> 基本的API</h3> <ul><li><strong>sk.bind(address)</strong></li></ul> <p>s.bind(address) 将套接字绑定到地址。address地址的格式取决于地址族。在AF_INET下，以元组（host,port）的形式表示地址。</p> <ul><li><strong>sk.listen(backlog)</strong></li></ul> <p>开始监听传入连接。backlog指定在拒绝连接之前，可以挂起的最大连接数量。</p> <pre><code>  backlog等于5，表示内核已经接到了连接请求，但服务器还没有调用accept进行处理的连接个数最大为5
  这个值不能无限大，因为要在内核中维护连接队列
</code></pre> <ul><li><strong>sk.setblocking(bool)</strong></li></ul> <p>是否阻塞（默认True），如果设置False，那么accept和recv时一旦无数据，则报错。</p> <ul><li><strong>sk.accept()</strong></li></ul> <p>接受连接并返回（conn,address）,其中conn是新的套接字对象，可以用来接收和发送数据。address是连接客户端的地址。</p> <p>接收TCP 客户的连接（阻塞式）等待连接的到来</p> <ul><li><strong>sk.connect(address)</strong></li></ul> <p>连接到address处的套接字。一般，address的格式为元组（hostname,port）,如果连接出错，返回socket.error错误。</p> <ul><li><strong>sk.connect_ex(address)</strong></li></ul> <p>同上，只不过会有返回值，连接成功时返回 0 ，连接失败时候返回编码，例如：10061</p> <ul><li><strong>sk.close()</strong></li></ul> <p>关闭套接字</p> <ul><li><strong>sk.recv(bufsize[,flag])</strong></li></ul> <p>接受套接字的数据。数据以字符串形式返回，bufsize指定最多可以接收的数量。flag提供有关消息的其他信息，通常可以忽略。</p> <ul><li><strong>sk.recvfrom(bufsize[.flag])</strong></li></ul> <p>与recv()类似，但返回值是（data,address）。其中data是包含接收数据的字符串，address是发送数据的套接字地址。</p> <ul><li><strong>sk.send(string[,flag])</strong></li></ul> <p>将string中的数据发送到连接的套接字。返回值是要发送的字节数量，该数量可能小于string的字节大小。即：可能未将指定内容全部发送。</p> <ul><li><strong>sk.sendall(string[,flag])</strong></li></ul> <p>将string中的数据发送到连接的套接字，但在返回之前会尝试发送所有数据。成功返回None，失败则抛出异常。</p> <pre><code>  内部通过递归调用send，将所有内容发送出去。
</code></pre> <ul><li><strong>sk.sendto(string[,flag],address)</strong></li></ul> <p>将数据发送到套接字，address是形式为（ipaddr，port）的元组，指定远程地址。返回值是发送的字节数。该函数主要用于UDP协议。</p> <ul><li><strong>sk.settimeout(timeout)</strong></li></ul> <p>设置套接字操作的超时期，timeout是一个浮点数，单位是秒。值为None表示没有超时期。一般，超时期应该在刚创建套接字时设置，因为它们可能用于连接的操作（如 client 连接最多等待5s ）</p> <ul><li><strong>sk.getpeername()</strong></li></ul> <p>返回连接套接字的远程地址。返回值通常是元组（ipaddr,port）。</p> <ul><li><strong>sk.getsockname()</strong></li></ul> <p>返回套接字自己的地址。通常是一个元组(ipaddr,port)</p> <ul><li><strong>sk.fileno()</strong></li></ul> <p>套接字的文件描述符</p> <h3 id="tcp-udp的使用代码"><a href="#tcp-udp的使用代码" aria-hidden="true" class="header-anchor">#</a> TCP/UDP的使用代码</h3> <h4 id="服务器"><a href="#服务器" aria-hidden="true" class="header-anchor">#</a> 服务器</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#__server__</span>
<span class="token keyword">import</span> socket
<span class="token comment">#tcp</span>
sk<span class="token operator">=</span>socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span>socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span><span class="token comment">#使用ipv4,TCP</span>
sk<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span><span class="token number">5333</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#一个元组监听（ip,端口号）</span>
sk<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token comment">#请求来了被挂起的最大数量，超过之后便不再接受请求</span>
sock<span class="token punctuation">,</span>addr<span class="token operator">=</span>sk<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#先accep之后会产生sock和addr使用本sock对象进行操作</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span><span class="token comment">#用一个while True来不断接受请求,若要处理多个请求请用多线程</span>
    data<span class="token operator">=</span>sock<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token comment">#一次接受1024个Bytes</span>
    recvmssage<span class="token operator">=</span>data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token comment">#客户端怎么编码就得怎么解码</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>recvmssage<span class="token punctuation">)</span>
    temp<span class="token operator">=</span><span class="token string">&quot;hello traveler&quot;</span>
    sock<span class="token punctuation">.</span>send<span class="token punctuation">(</span>temp<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#可以指定也可以不制定编码</span>
    sock<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#Tcp一定要关闭连接</span>
<span class="token comment">#上述程序进行一次之后接收不到东西就会停止，需要client不断发送自行控制吧</span>

<span class="token comment">#udp</span>
sk <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span>socket<span class="token punctuation">.</span>SOCK_DGRAM<span class="token punctuation">)</span><span class="token comment">#使用ipv4,UDP</span>
sk<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span><span class="token number">5333</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#需要绑定(&quot;ip&quot;,port)</span>
data<span class="token punctuation">,</span> addr <span class="token operator">=</span> sk<span class="token punctuation">.</span>recvfrom<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token comment">#接受到 数据,地址(地址要留着后面还要发回去)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#打印</span>
temp<span class="token operator">=</span><span class="token string">&quot;the light will bring me vicetory&quot;</span>
sk<span class="token punctuation">.</span>sendto<span class="token punctuation">(</span>temp<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>addr<span class="token punctuation">)</span><span class="token comment">#发送到addr</span>

</code></pre></div><h4 id="客户端"><a href="#客户端" aria-hidden="true" class="header-anchor">#</a> 客户端</h4> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#__client__</span>
<span class="token keyword">import</span> socket
<span class="token comment">#tcp</span>
sk<span class="token operator">=</span>socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span>socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span><span class="token comment">#使用ipv4 TCP</span>
sk<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span><span class="token number">5333</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#TCP是需要连接的</span>
temp<span class="token operator">=</span><span class="token string">&quot;hello remote people&quot;</span>
sk<span class="token punctuation">.</span>send<span class="token punctuation">(</span>temp<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#发送同样需要编码</span>
d<span class="token operator">=</span>sk<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token comment">#接收字节并解码</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
sk<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#需要关闭</span>

<span class="token comment">#udp</span>
sk <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_DGRAM<span class="token punctuation">)</span><span class="token comment">#用ipv4,UDP</span>
addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span><span class="token number">5333</span><span class="token punctuation">)</span><span class="token comment">#先确定自己的地址</span>
data<span class="token operator">=</span><span class="token string">&quot;ha? me?&quot;</span>
sk<span class="token punctuation">.</span>sendto<span class="token punctuation">(</span>data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token comment">#发送到，记得编码</span>
recvdata<span class="token punctuation">,</span> addr<span class="token operator">=</span>sk<span class="token punctuation">.</span>recvfrom<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token comment">#接受，同样需要区大小，最好能给个buffer</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>recvdata<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#发送的时候要记得编码</span>

</code></pre></div><h3 id="socketserver的使用"><a href="#socketserver的使用" aria-hidden="true" class="header-anchor">#</a> socketserver的使用</h3> <p>继承关系如图
<img src="https://upload-images.jianshu.io/upload_images/12620393-ec7af0bec463f5d3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="socketserver的继承"></p> <p>import socketserver<br>
封装好了一些东西了拿来直接用<br>
调用方式为<br>
sock=socketserver.ThreadTCPServer((&quot;ip&quot;,port),HandlerClass)<br>
sock.server_forever如果知道应用程序只能操纵面向数据流的连接（如TCP），那么应从StreamRequestHandler继承，而不是BaseRequestHandler。StreamRequestHandler类设置了两个属性，<br>
h.wfile是将数据写入客户端的类文件对象，h.rfile是从客户端读取数据的类文件对象。<br>
如果要编写针对数据包操作的处理程序并将响应持续返回发送方，那么它应当从DatagramRequestHandler继承。<br>
它提供的类接口与StramRequestHandler相同。<br>
常用的handler属性<br>
h.client_address#客户端地址<br>
h.server#获取自己的server对象<br>
h.request<br>
对 TCP server，h.request 属性是连接到 client 的连接套接字对象；就是那个socket<br>
对 UDP server，h.request 属性是一个二元组(data, sock)，data 是 client 端发送的数据（最大8192字节），sock是server端套接字。<br>
　　使用这个属性可以获取在这个进/线程中与client套接字建立连接的连接套接字，从而可以使用这个套接字与client端通信。<br>
　　 StreamRequestHandler 和 DatagramRequestHandler 则屏蔽了 self.request 对TCP和UDP连接的区别，二者都重定义了 setup() 和 finish() 方法，提供统一的 self.rfile 和 self.wfile 属性以便从客户端读取数据或向客户端发送数据。<br>
代码如下</p> <div class="danger custom-block"><p class="custom-block-title">留坑</p> <p>这里没怎么实验</p></div> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> socketserver <span class="token keyword">import</span> BaseRequestHandler

<span class="token keyword">class</span> <span class="token class-name">MyHandl</span><span class="token punctuation">(</span>BaseRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">setup</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;begine&quot;</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        conn<span class="token operator">=</span>self<span class="token punctuation">.</span>request<span class="token comment">#拿到请求对象</span>
        data<span class="token operator">=</span>conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token comment">#接收</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        temp<span class="token operator">=</span><span class="token string">&quot;你好，你好~&quot;</span>
        conn<span class="token punctuation">.</span>sendall<span class="token punctuation">(</span>temp<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>client_address<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">finish</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;over&quot;</span><span class="token punctuation">)</span>

</code></pre></div><ul><li>ThreadTCPServer<br></li> <li>ThreadUDPServer<br></li> <li>ThreadingUnixStreamServer<br></li> <li>ThreadingUnixDatagramServer<br>
所有的Server都有下面的方法</li></ul> <table><thead><tr><th>类或者方法</th> <th style="text-align:center">作用</th></tr></thead> <tbody><tr><td>sock.socket</td> <td style="text-align:center">用于传入请求的套接字对象</td></tr> <tr><td>sock.server_address</td> <td style="text-align:center">监听服务器的地址.比如元组(&quot;127.0.0.1&quot;,80)</td></tr> <tr><td>sock.RequestHandlerClass</td> <td style="text-align:center">传递给服务器构造函数并由用户提供的请求处理程序类</td></tr> <tr><td>sock.serve_forever()</td> <td style="text-align:center">处理无限的请求</td></tr> <tr><td>sock.shutdown()</td> <td style="text-align:center">停止serve_forever()循环</td></tr> <tr><td>sock.fileno()</td> <td style="text-align:center">返回服务器套接字的整数文件描述符.该方法可以有效的通过轮询操作(如select()函数)使用服务器实例</td></tr></tbody></table> <h2 id="多线程"><a href="#多线程" aria-hidden="true" class="header-anchor">#</a> 多线程</h2> <p>python中的一个线程对应c中的一个线程<br>因为GIL,在某一时刻只能有一个线程在一个cpu上执行字节码无法将多个线程映射到多个核上<br>
GIL不是在本线程使用完之后才会释放<br>根据执行的字节码和时间片和IO操作才释放，导致线程不安全<br>
最开始语言使用的都是多进程，对系统资源消耗很大，后来开始使用线程，线程是依附于进程的，<br>操作系统能调度的最小单位是线程IO为主的程序性能差别不大<br>
具体请看<a href="www.baidu.com">操作系统-线程和进程</a><br></p> <h3 id="使用线程函数和线程类"><a href="#使用线程函数和线程类" aria-hidden="true" class="header-anchor">#</a> 使用线程函数和线程类</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#-*-coding:utf-8-*-</span>
<span class="token comment">#SettingCode here</span>
__author__ <span class="token operator">=</span> <span class="token string">&quot;a_little_rubbish&quot;</span>
__date__ <span class="token operator">=</span> <span class="token string">&quot;2018/11/19 8:48&quot;</span>

<span class="token comment">#import your model here</span>
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread
<span class="token comment">#your class&amp;function here</span>

<span class="token keyword">class</span> <span class="token class-name">sayHello</span><span class="token punctuation">(</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#创建一个线程类</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>someone<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#init传参数</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#调用父类的构造</span>
        self<span class="token punctuation">.</span>someone<span class="token operator">=</span>someone<span class="token comment">#参数</span>
        self<span class="token punctuation">.</span>daemon <span class="token operator">=</span> <span class="token boolean">True</span><span class="token comment">#在这里设置守护线程</span>
    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#重写run函数线程会执行这个函数</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Hello &quot;</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>someone<span class="token punctuation">)</span>



<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">sayHi</span><span class="token punctuation">(</span>someone<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#定义一个线程要用的函数</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;Hi &quot;</span><span class="token punctuation">,</span>someone<span class="token punctuation">)</span>

    t <span class="token operator">=</span> Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>sayHi<span class="token punctuation">,</span>args <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">&quot;janny&quot;</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#实例化一个县城</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#开始执行</span>

    namelist<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&quot;天使&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;76&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;Bob&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;安娜&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;法鸡&quot;</span><span class="token punctuation">]</span>
    ThreadList<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token comment">#定义一个线程列表</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> namelist<span class="token punctuation">:</span>
        ThreadList<span class="token punctuation">.</span>append<span class="token punctuation">(</span>sayHello<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#添加线程</span>
    ThreadList<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>setDaemon<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token comment">#设置为守护线程,其他线程结束的时候自动结束</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ThreadList<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>isAlive<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#返回线程是否还活着</span>
    ThreadList<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>setName<span class="token punctuation">(</span><span class="token string">&quot;你好线程&quot;</span><span class="token punctuation">)</span><span class="token comment">#设置线程名。</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>ThreadList<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#返回线程名。</span>

    <span class="token keyword">for</span> t <span class="token keyword">in</span> ThreadList<span class="token punctuation">:</span>
        t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#开始一个线程</span>
</code></pre></div><pre><code>Hi False
 你好线程
janny
Hello  天使
Hello  76
Hello  Bob
Hello  安娜
Hello  法鸡
</code></pre> <h3 id="线程安全队列"><a href="#线程安全队列" aria-hidden="true" class="header-anchor">#</a> 线程安全队列</h3> <p>LIFO队列 基本FIFO队列 优先级队列<br>
这三种基础队列已经实现了线程安全</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#-*-coding:utf-8-*-</span>
<span class="token comment">#SettingCode here</span>
__author__ <span class="token operator">=</span> <span class="token string">&quot;a_little_rubbish&quot;</span>
__date__ <span class="token operator">=</span> <span class="token string">&quot;2018/11/19 11:36&quot;</span>

<span class="token comment">#import your model here</span>
<span class="token keyword">from</span> queue <span class="token keyword">import</span> Queue<span class="token punctuation">,</span>LifoQueue<span class="token punctuation">,</span>PriorityQueue
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread

<span class="token keyword">import</span> time
<span class="token comment">#your class&amp;function here</span>



<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    <span class="token comment">#先进先出FIFO 也就是基本的Queue</span>
    q<span class="token operator">=</span>Queue<span class="token punctuation">(</span>maxsize<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token comment">#定义最大容量,满了就会阻塞线程,不定义就默认无上限</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        q<span class="token punctuation">.</span>put<span class="token punctuation">(</span>i<span class="token punctuation">,</span>timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token comment">#往里放一个东西,超时时间</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span>timeout<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#返回了一个取出的值，超时等待时间</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;--------分割----------&quot;</span>    <span class="token punctuation">)</span>

    <span class="token comment">#先进后出LIFO</span>
    q<span class="token operator">=</span>LifoQueue<span class="token punctuation">(</span>maxsize<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        q<span class="token punctuation">.</span>put<span class="token punctuation">(</span>i<span class="token punctuation">)</span>

    <span class="token comment">#q.join()#会直接在这里卡住不动,等队列清空并且task_down发出才会执行</span>
    <span class="token comment"># 可以配合empty full 判断是不是消费或者生产结束</span>

    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;--------分割----------&quot;</span>    <span class="token punctuation">)</span>

    <span class="token comment">#优先级队存储一个元组,数字越小优先级越高</span>
    <span class="token keyword">from</span> random <span class="token keyword">import</span> randint
    q<span class="token operator">=</span>PriorityQueue<span class="token punctuation">(</span>maxsize<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token comment">#maxsize同上</span>
    <span class="token keyword">for</span> p <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token builtin">chr</span><span class="token punctuation">(</span>randint<span class="token punctuation">(</span><span class="token number">65</span><span class="token punctuation">,</span><span class="token number">90</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#随机生成数字和字母的列表表达式</span>
        q<span class="token punctuation">.</span>put<span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>qsize<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#获取队列的长度</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#队列是空的吗</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>full<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#队列是满的吗</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>join()会暂时挂起队列和妄图注入队列的线程，直到队列清空<br>每娶一个就要执行task_down()否则他不知道这个队列已经空了就会一直挂着。。。
就是用join的时候就一定要每次取完task_down一下</p> <h3 id="线程锁"><a href="#线程锁" aria-hidden="true" class="header-anchor">#</a> 线程锁</h3> <p>锁要小心使用<br>
假设得到a，b才能运行<br>
线程A得到了b,B得到了A<br>
AB都不能运行<br></p> <div class="danger custom-block"><p class="custom-block-title">WARNING</p> <p>锁里在获得锁会死锁<br>
注意锁只能被一个线程获得执行释放之后其他线程才会使用</p></div> <p>锁使用代码如下</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#-*-coding:utf-8-*-</span>
<span class="token comment">#SettingCode here</span>
__author__ <span class="token operator">=</span> <span class="token string">&quot;a_little_rubbish&quot;</span>
__date__ <span class="token operator">=</span> <span class="token string">&quot;2018/11/19 15:58&quot;</span>

<span class="token comment">#import your model here</span>
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Lock<span class="token punctuation">,</span>RLock<span class="token comment">#引入锁</span>
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread
<span class="token comment">#your class&amp;function here</span>
a <span class="token operator">=</span> <span class="token number">0</span>
lock<span class="token operator">=</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
rLock<span class="token operator">=</span>RLock<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">add1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> a
    <span class="token keyword">global</span> lock
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        lock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#获得锁</span>
        a <span class="token operator">+=</span> <span class="token number">1</span>
        lock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#释放锁</span>

<span class="token keyword">def</span> <span class="token function">sub1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> a
    <span class="token keyword">global</span> rLock
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        rLock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#在一个线程内可重复获得的锁</span>
        rLock<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#重复获得</span>
        a <span class="token operator">-=</span> <span class="token number">1</span>
        rLock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#一定要有对应次数的释放</span>
        rLock<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    t1<span class="token operator">=</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>add1<span class="token punctuation">)</span>
    t2<span class="token operator">=</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>sub1<span class="token punctuation">)</span>
    t1<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t2<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    <span class="token comment">#如果去掉锁的话结果a会乱</span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">产生死锁的四个必要条件：</p> <p>（1） 互斥条件：一个资源每次只能被一个进程使用。</p> <p>（2） 请求与保持条件：一个进程因请求资源而阻塞时，对已获得的资源保持不放。</p> <p>（3） 不剥夺条件:进程已获得的资源，在末使用完之前，不能强行剥夺。</p> <p>（4） 循环等待条件:若干进程之间形成一种头尾相接的循环等待资源关系。</p></div> <h3 id="条件变量"><a href="#条件变量" aria-hidden="true" class="header-anchor">#</a> 条件变量</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#-*-coding:utf-8-*-</span>
<span class="token comment">#SettingCode here</span>
__author__ <span class="token operator">=</span> <span class="token string">&quot;a_little_rubbish&quot;</span>
__date__ <span class="token operator">=</span> <span class="token string">&quot;2018/11/19 16:29&quot;</span>

<span class="token comment">#import your model here</span>
<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread<span class="token punctuation">,</span>Condition

<span class="token comment">#your class&amp;function here</span>
<span class="token keyword">class</span> <span class="token class-name">TianMao</span><span class="token punctuation">(</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>cond<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cond <span class="token operator">=</span> cond

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>cond<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#获得</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;天猫:1&quot;</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cond<span class="token punctuation">.</span>notify<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#会发送一个信号</span>
        self<span class="token punctuation">.</span>cond<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#没收到信号之前会阻塞</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;天猫:3&quot;</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cond<span class="token punctuation">.</span>notify<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#会发送一个信号</span>
        self<span class="token punctuation">.</span>cond<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#没收到信号之前会阻塞</span>

        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;天猫:5&quot;</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cond<span class="token punctuation">.</span>notify<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#会发送一个信号</span>
        self<span class="token punctuation">.</span>cond<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#没收到信号之前会阻塞</span>

        self<span class="token punctuation">.</span>cond<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#一定记得释放掉</span>


<span class="token keyword">class</span> <span class="token class-name">XiaoAi</span><span class="token punctuation">(</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>cond<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cond<span class="token operator">=</span>cond

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#和天猫的调用一样，两种调用方式</span>
        <span class="token keyword">with</span> self<span class="token punctuation">.</span>cond<span class="token punctuation">:</span><span class="token comment">#with 好用</span>

            self<span class="token punctuation">.</span>cond<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;小爱:2&quot;</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>cond<span class="token punctuation">.</span>notify<span class="token punctuation">(</span><span class="token punctuation">)</span>

            self<span class="token punctuation">.</span>cond<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;小爱:4&quot;</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>cond<span class="token punctuation">.</span>notify<span class="token punctuation">(</span><span class="token punctuation">)</span>

            self<span class="token punctuation">.</span>cond<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;小爱:6&quot;</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>cond<span class="token punctuation">.</span>notify<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    cond<span class="token operator">=</span>Condition<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t <span class="token operator">=</span> TianMao<span class="token punctuation">(</span>cond<span class="token punctuation">)</span>
    x <span class="token operator">=</span> XiaoAi<span class="token punctuation">(</span>cond<span class="token punctuation">)</span>
    x<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">提示</p> <p>启动顺序很重要,如果notify先启动了那么没有wait的线程就会卡住<br>
with cond/acquire 之后才能使用wait和notify<br>
condition原理是两层锁，底层锁在线程调用了wait的时候释放，上面的锁在每次wait的时候分配一把放到cond的等待队列中去，等notify的唤醒<br></p></div> <h3 id="信号量"><a href="#信号量" aria-hidden="true" class="header-anchor">#</a> 信号量</h3> <p>和锁一样用,可以不用同一个函数来释放，可以调用多个<br>
是个全局对象<br>
定义n个信号量，每次qcquire就-1，每次release就+1减到了0 就会锁住<br></p> <p>使用代码如下</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#-*-coding:utf-8-*-</span>
<span class="token comment">#SettingCode here</span>
__author__ <span class="token operator">=</span> <span class="token string">&quot;a_little_rubbish&quot;</span>
__date__ <span class="token operator">=</span> <span class="token string">&quot;2018/11/19 17:10&quot;</span>

<span class="token comment">#import your model here</span>

<span class="token keyword">from</span> threading <span class="token keyword">import</span> Thread<span class="token punctuation">,</span>Semaphore
<span class="token keyword">import</span> time
<span class="token comment">#your class&amp;function here</span>
<span class="token keyword">class</span> <span class="token class-name">consumer</span><span class="token punctuation">(</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>sem<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>sem<span class="token operator">=</span>sem

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;eat!&quot;</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>sem<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">producer</span><span class="token punctuation">(</span>Thread<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sem<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>sem <span class="token operator">=</span> sem

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>sem<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;make!&quot;</span><span class="token punctuation">)</span>
        consumer<span class="token punctuation">(</span>self<span class="token punctuation">.</span>sem<span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__<span class="token operator">==</span><span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    sem<span class="token operator">=</span>Semaphore<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        p<span class="token operator">=</span>producer<span class="token punctuation">(</span>sem<span class="token punctuation">)</span>
        p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><pre><code>make!make!

make!
eat!eat!eat!

make!
make!make!


eat!
eat!
make!
make!
eat!
make!
eat!
eat!
make!
make!eat!

make!
eat!eat!

make!
make!
eat!
make!
eat!
eat!
make!
make!
eat!
make!
eat!eat!
make!

make!
eat!
eat!
eat!
</code></pre> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>程序结构基本就是一个生产者线程拉起一个消费者线程，消费者消费完了才会释放信号量</p></div> <h3 id="线程池"><a href="#线程池" aria-hidden="true" class="header-anchor">#</a> 线程池</h3> <p>对线程进行管理，调用线程状态，获取线程返回值，进行池化管理<br>
子线程完成之后主线程能够立即知道
代码如下</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#-*-coding:utf-8-*-</span>
<span class="token comment">#SettingCode here</span>
__author__ <span class="token operator">=</span> <span class="token string">&quot;a_little_rubbish&quot;</span>
__date__ <span class="token operator">=</span> <span class="token string">&quot;2018/11/19 18:57&quot;</span>

<span class="token comment">#import your model here</span>
<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor<span class="token punctuation">,</span>as_completed<span class="token punctuation">,</span>wait<span class="token punctuation">,</span>ALL_COMPLETED

<span class="token keyword">import</span> time
<span class="token comment">#your class&amp;function here</span>
<span class="token keyword">def</span> <span class="token function">go</span><span class="token punctuation">(</span>times<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>times<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;{}is done&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>times<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token string">&quot;it is {} done&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>times<span class="token punctuation">)</span><span class="token comment">#函数有返回值</span>


executor<span class="token operator">=</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token comment">#n个线程并发执行</span>

task1<span class="token operator">=</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>go<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#提交一个线程对象到池中，池中可以放无数个，但是只能同时执行max_workers个</span>
task2<span class="token operator">=</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>go<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#submit提交了之后会立即执行，附带了execute了</span>
<span class="token comment">#task是一个future对象</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>task2<span class="token punctuation">.</span>done<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#获取函数是否执行完了。</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;取消1成功了吗&quot;</span><span class="token punctuation">,</span>task1<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#尝试取消一个线程，取消成功Ture，否则False</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;取消2成功了吗&quot;</span><span class="token punctuation">,</span>task2<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#完成了的线程无法取消，未完成已经在池中的可以取消</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>task1<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#获取执行完之后的返回结果</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>task2<span class="token punctuation">.</span>done<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment">#穷举是比较低级的做法</span>
    t<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">]</span>
    all_task<span class="token operator">=</span><span class="token punctuation">[</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>go<span class="token punctuation">,</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> t<span class="token punctuation">]</span><span class="token comment">#迭代放进一个线程池</span>
    <span class="token keyword">for</span> future <span class="token keyword">in</span> as_completed<span class="token punctuation">(</span>all_task<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#允许异步的等代线程池中完成的线程并取回结果</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#谁先做完取回谁</span>

    wait<span class="token punctuation">(</span>all_task<span class="token punctuation">,</span>return_when<span class="token operator">=</span>ALL_COMPLETED<span class="token punctuation">)</span><span class="token comment">#等all_task全执行完才执行main线程</span>
    <span class="token triple-quoted-string string">'''
    FIRST_COMPLETED = 'FIRST_COMPLETED'
    FIRST_EXCEPTION = 'FIRST_EXCEPTION'
    ALL_COMPLETED = 'ALL_COMPLETED'
    _AS_COMPLETED = '_AS_COMPLETED'
    可以取上面的值
    '''</span>

    <span class="token comment">#使用map</span>
    <span class="token keyword">for</span> future <span class="token keyword">in</span> executor<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span>go<span class="token punctuation">,</span>t<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#和map是一个道理 映射</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>future<span class="token punctuation">)</span><span class="token comment">#直接可以打印结果哦，返回顺序和url的顺序一致</span>
</code></pre></div><h2 id="多进程"><a href="#多进程" aria-hidden="true" class="header-anchor">#</a> 多进程</h2> <p><a href>操作系统-进程</a>
进程之间是相互独立的，变量空间按不能共享，各进程保留一份代码副本和运行堆栈需要用特殊的数据结构来访问<br></p> <div class="tip custom-block"><p class="custom-block-title">windows 和 linux</p> <p>linux下子进程永远返回0，而父进程返回子进程的ID。这样做的理由是，一个父进程可以fork出很多子进程，所以，父进程要记下每个子进程的ID，而子进程只需要调用getppid()就可以拿到父进程的ID。<br></p></div> <h3 id="进程池"><a href="#进程池" aria-hidden="true" class="header-anchor">#</a> 进程池</h3> <p>ProcessPoolExecutor 代替ThreadPoolExecutor就可以了，接口形状一样<br>
代码如下</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#-*-coding:utf-8-*-</span>
<span class="token comment">#SettingCode here</span>
__author__ <span class="token operator">=</span> <span class="token string">&quot;a_little_rubbish&quot;</span>
__date__ <span class="token operator">=</span> <span class="token string">&quot;2018/11/19 20:07&quot;</span>

<span class="token comment">#import your model here</span>
<span class="token keyword">import</span> multiprocessing

<span class="token comment">#your class&amp;function here</span>
<span class="token keyword">def</span> <span class="token function">go</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;it seems like &quot;</span><span class="token punctuation">,</span>a<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token string">&quot;it is {} done &quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
   p<span class="token operator">=</span>multiprocessing<span class="token punctuation">.</span>Process<span class="token punctuation">(</span>target<span class="token operator">=</span>go<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token comment">#没启动的时候为None</span>
   p<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token keyword">print</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token comment">#启动了返回pid</span>
   p<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>

   <span class="token comment">#使用池</span>
   pool<span class="token operator">=</span>multiprocessing<span class="token punctuation">.</span>Pool<span class="token punctuation">(</span>multiprocessing<span class="token punctuation">.</span>cpu_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#传入worker数量默认为cpu核数量</span>
   result<span class="token operator">=</span>pool<span class="token punctuation">.</span>apply_async<span class="token punctuation">(</span>go<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#和commit一个作用直接传进去</span>

   pool<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#不再接受新的进程任务</span>
   pool<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#可以一次性将池中的进程都阻塞</span>
   <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

   <span class="token keyword">for</span> result <span class="token keyword">in</span> pool<span class="token punctuation">.</span>imap<span class="token punctuation">(</span>go<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#异步返回结果，一次性提交</span>
       <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

   <span class="token keyword">for</span> result <span class="token keyword">in</span> pool<span class="token punctuation">.</span>imap_unordered<span class="token punctuation">(</span>go<span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#异步返回结果，一次性提交，无序</span>
       <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
</code></pre></div><h3 id="进程之间通信"><a href="#进程之间通信" aria-hidden="true" class="header-anchor">#</a> 进程之间通信</h3> <ul><li>Queue.qsize()：返回当前队列包含的消息数量；</li> <li>Queue.empty()：如果队列为空，返回True，反之False ；</li> <li>Queue.full()：如果队列满了，返回True,反之False；</li> <li>Queue.get():获取队列中的一条消息，然后将其从列队中移除，可传参超时时长。</li> <li>Queue.get_nowait()：相当Queue.get(False),取不到值时触发异常：Empty；</li> <li>Queue.put():将一个值添加进数列，可传参超时时长。</li> <li>Queue.put_nowait():相当于Queue.get(False),当队列满了时报错：Full。</li></ul> <div class="danger custom-block"><p class="custom-block-title">WARNING</p> <p>windows下所有关于进程的操作都要放在if <strong>name</strong> == '<strong>main</strong>':下面进行，否则会报错
在使用进程池的时候必须用Manager()对象的Queue不然会出错</p></div> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">import</span> multiprocessing
<span class="token keyword">from</span> multiprocessing <span class="token keyword">import</span> Queue<span class="token punctuation">,</span>Pipe<span class="token punctuation">,</span>Manager<span class="token punctuation">,</span>Lock<span class="token punctuation">,</span>Process
<span class="token keyword">import</span> time

<span class="token keyword">def</span> <span class="token function">putit</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">:</span>
    q<span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'aaa'</span>
    <span class="token comment">#q.put([1,2,3])</span>
    <span class="token comment">#print(q.qsize())</span>

<span class="token keyword">def</span> <span class="token function">getit</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">:</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>q<span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment">#print(q.get())</span>
    <span class="token comment">#print(q.qsize())</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    Q <span class="token operator">=</span> Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 在使用进程池的时候，会出错，使用manage.Queue()</span>
    P <span class="token operator">=</span> Pipe<span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">)</span>  <span class="token comment"># 设置为False就是单向队列</span>
    M <span class="token operator">=</span> Manager<span class="token punctuation">(</span><span class="token punctuation">)</span>
    D <span class="token operator">=</span> M<span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    MQ <span class="token operator">=</span> M<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># a = Process(target=putit, args=(Q,))</span>
    <span class="token comment"># b = Process(target=getit, args=(Q,))</span>
    a <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>putit<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>D<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    b <span class="token operator">=</span> Process<span class="token punctuation">(</span>target<span class="token operator">=</span>getit<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>D<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    a<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    b<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    a<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
    b<span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>复杂的数据对象用M.dict，简单的用list，所有的数据结构去源码里看看</p> <h2 id="异步"><a href="#异步" aria-hidden="true" class="header-anchor">#</a> 异步</h2> <h3 id="异步基本概念"><a href="#异步基本概念" aria-hidden="true" class="header-anchor">#</a> 异步基本概念</h3> <h4 id="并发-并行-阻塞-非阻塞-同步-异步"><a href="#并发-并行-阻塞-非阻塞-同步-异步" aria-hidden="true" class="header-anchor">#</a> 并发 并行 阻塞 非阻塞 同步 异步<br></h4> <ol><li><strong>并发</strong> 在某一时间段内有多个程序运行在一个cpu上<br></li> <li><strong>并行</strong> 在某一时刻有多个程序运行在多个cpu上<br></li> <li><strong>阻塞</strong> 调用函数时当前函数被挂起<br></li> <li><strong>非阻塞</strong>调用函数线程不会被挂起会立即返回<br></li> <li><strong>同步IO</strong> 发出请求之后等待结果<br></li> <li><strong>异步IO</strong> 发出请求之后立即返回，不等待结果uinx下五种IO模型
<ul><li>阻塞式IO</li> <li>非阻塞式IO</li> <li>IO多路复用</li> <li>异步IO（协程）</li> <li>信号驱动式IO（用的少）select、poll、epoll</li></ul></li></ol> <h3 id="三种异步机制"><a href="#三种异步机制" aria-hidden="true" class="header-anchor">#</a> 三种异步机制</h3> <div class="danger custom-block"><p class="custom-block-title">留坑</p> <p>需要花时间好好整理</p></div> <p>select, poll , epoll都是I〇多路复用的机制。I/O多路复用就是通过一种机
制，一个进程可以监视多个描述符，一旦某个描述符就绪（一般是读就绪或
者写就绪），能够通知程序进行相应的读写操作。但select, poll , epoll本
质上都是同步I/O ,因为他们都需要在读写事件就绪后自己负责进行读写，
也就是说这个读写过程是阻塞的，而异步I/O则无需自己负责进行读写，异
步I/O的实现会负责把数据从内核拷贝到用户空间。select</p> <p>select函数监视的文件描述符分3类，分别是writefds、readfds、和
exceptfds。调用后select函数会阻塞，直到有描述副就绪（有数据可读、
可写、或者有except),或者超时（timeout指定等待时间，如果立即返回
设为null即可），函数返回。当select函数返回后，可以通过遍历fdset,来
找到就绪的描述符。</p> <p>select目前几乎在所有的平台上支持，其良好跨平台支持也是它的一个
优点。selec啲一个缺点在于单个进程能够监视的文件描述符的数量存在最
大限制，在Linux上一般为1024 ,可以通过修改宏定义甚至重新编译内核的
方式提升这一限制，但是这样也会造成效率的降低。poll</p> <p>不同与select使用三个位图来表示三个fdset的方式，poll使用一个
pollfd的指针实现。</p> <p>pollfd结构包含了要S见的event和发生的event,不再使用select &quot;参
数-填〃传递的方式。同时，poNfd并没有最大数量限制（但是数量过大后
性能也是会下降）。和select函数_样，poll返回后，需要轮询pollfd来获
取就绪的描述符。</p> <p>从上面看，select和poll都需要在返回后，通过遍历文件描述符来获取
已经就绪的socket。事实上，同时连接的大量客户端在一时刻可能只有很少
的处于就绪状态，因此随着监视的描述符数量的增长，其效率也会线性下降epoll
linux支持，windows不支持
epoll是在2.6内核中提出的，是之前的select和poll的增强版本。
相对于select和poll来说，epol更加灵活，没有描述符限制。
epoll使用一个文件描述符管理多个描述符，
将用户关系的文件描述符的事件存放到内核的一个事件表中，这样在用户空间和内核空间的copy只需一次。
代码</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#-*-coding:utf-8-*-</span>
<span class="token comment">#SettingCode here</span>
__author__ <span class="token operator">=</span> <span class="token string">&quot;a_little_rubbish&quot;</span>
__date__ <span class="token operator">=</span> <span class="token string">&quot;2018/11/21 19:29&quot;</span>

<span class="token comment">#import your model here</span>
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> time
<span class="token keyword">from</span> functools <span class="token keyword">import</span> partial
<span class="token comment">#your class&amp;function here</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">gethtml</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;start &quot;</span><span class="token operator">+</span>html<span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token comment">#异步等待</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'end '</span><span class="token operator">+</span>html<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">&quot;窝做完了&quot;</span>

<span class="token keyword">def</span> <span class="token function">callback</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span>future<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#使用partial时参数必须按顺序摆放，调用时是先传入的地址，loop又给的future</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;I have send it to &quot;</span><span class="token punctuation">,</span>address<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    start_time<span class="token operator">=</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    loop<span class="token operator">=</span>asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#创建一个协程池</span>
    loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>gethtml<span class="token punctuation">(</span><span class="token string">&quot;a.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#基本用法，提交一个协程对象立即异步运行</span>

<span class="token comment">#使用future</span>

    get_future<span class="token operator">=</span>asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>gethtml<span class="token punctuation">(</span><span class="token string">&quot;b.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#和loop.create_task的方法作用一样，返回一个future对象,参考submit，把协程对象放进去</span>
    loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>get_future<span class="token punctuation">)</span><span class="token comment">#传入协程future并运行，会直接对原先的队列做操作</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>get_future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#打印处理完的返回值</span>

<span class="token comment"># 使用task，可以添加回调</span>

    task <span class="token operator">=</span> loop<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>gethtml<span class="token punctuation">(</span><span class="token string">&quot;c.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># task和future一样，是future的子类</span>
    task<span class="token punctuation">.</span>add_done_callback<span class="token punctuation">(</span>partial<span class="token punctuation">(</span>callback<span class="token punctuation">,</span><span class="token string">&quot;576359186@qq.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#太难嫁一个回调,在任务完成时就会调用，会自动向callback传入一个完成了的future</span>
    loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>task<span class="token punctuation">)</span>  <span class="token comment"># 传入协程future并运行，会直接对原先的队列做操作</span>
    <span class="token comment">#partial函数用于把（函数，参数）包裹起来形成一个新的（句柄）可供其他函数接收</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 打印处理完的返回值</span>

<span class="token comment">#使用任务队列</span>

    tasks<span class="token operator">=</span><span class="token punctuation">[</span>gethtml<span class="token punctuation">(</span><span class="token string">&quot;a.com&quot;</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token comment">#任务列表，全是协程对象</span>
    <span class="token comment">#loop.run_until_complete(asyncio.wait(tasks))#传入asyncio.wait(任务列表)默认直到全完成才退出</span>
    tasks2 <span class="token operator">=</span> <span class="token punctuation">[</span>gethtml<span class="token punctuation">(</span><span class="token string">&quot;a.com&quot;</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    tasks2<span class="token operator">=</span>asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>tasks2<span class="token punctuation">)</span>
    <span class="token comment">#wait方法和线程中的wait方法一样，会阻塞线程直到满足returnwhen然后触发一个事件继续进行</span>
    loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>gather<span class="token punctuation">(</span><span class="token operator">*</span>tasks<span class="token punctuation">,</span>tasks2<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">#可以直接task2.cancel()取消队列中的任务</span>
    <span class="token comment"># gather更加高层，*tasks可以将task传入，可传入多个taskgroup,注意task和task2</span>


    <span class="token keyword">print</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>start_time<span class="token punctuation">)</span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">使用场景</p> <p>包含各种特定系统实现的模块化事件循环传输和协议抽象<br>
对TCP、UDP、SSL、子进程、延时调用以及其他的具体支持模仿futures模块但适用于事件循环使用的Future类型<br>
基于yield from的协议和任务，可以让你用顺序的方式编写并发代码必须使用一个将产生阻塞IO的调用时<br>
有接口可以把这个事件转移到线程池莫仿threading模块中的同步原语、可以用在单线程内的协程之间<br></p></div> <h3 id="asyncio生态"><a href="#asyncio生态" aria-hidden="true" class="header-anchor">#</a> asyncio生态</h3> <p>asyncio官方只实现了比较底层的协议，比如TCP，UDP。所以诸如HTTP协议之类都需要借助第三方库，比如aiohttp。<br></p> <p>虽然异步编程的生态不够同步编程的生态那么强大，但是如果又高并发的需求不妨试试，下面说一下比较成熟的异步库</p> <p><a href="https://aiohttp.readthedocs.io/en/stable/">aiohttp</a>
异步http client/server框架</p> <p><a href="https://sanic.readthedocs.io/en/latest/">sanic</a><br>
速度更快的类flask web框架。<br></p> <p><a href="https://uvloop.readthedocs.io/">uvloop</a>
快速，内嵌于asyncio事件循环的库，使用cython基于libuv实现。<br>
官方性能测试:<br>
nodejs的两倍，追平golang<br>
为了减少歧义，这里的性能测试应该只是网络IO高并发方面不是说任何方面追平golang。<br>
摘自哪个博客我给忘了,回头找到了就添上</p> <h3 id="小总结"><a href="#小总结" aria-hidden="true" class="header-anchor">#</a> 小总结</h3> <p>Python之所以能够处理网络IO高并发，是因为借助了高效的IO模型，能够最大限度的调度IO，然后事件循环使用协程处理IO，协程遇到IO操作就将控制权抛出，那么在IO准备好之前的这段事件，事件循环就可以使用其他的协程处理其他事情，然后协程在用户空间，并且是单线程的，所以不会像多线程，多进程那样频繁的上下文切换，因而能够节省大量的不必要性能损失。<br></p> <div class="warning custom-block"><p class="custom-block-title">注意</p> <p>不要再协程里面使用time.sleep之类的同步操作，因为协程再单线程里面，所以会使得整个线程停下来等待，也就没有协程的优势了</p></div> <p>本文主要讲解Python为什么能够处理高并发,不是为了讲解某个库怎么使用,所以使用细节请查阅官方文档或者执行。<br></p> <p>无论什么编程语言，高性能框架，一般由事件循环 + 高性能IO模型(也许是epoll)组成</p> <h3 id="async关键字"><a href="#async关键字" aria-hidden="true" class="header-anchor">#</a> async关键字</h3> <p>可以异步的定义函数</p> <div class="danger custom-block"><p class="custom-block-title">WARNING</p> <p>留坑</p></div> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#-*-coding:utf-8-*-</span>
<span class="token comment">#SettingCode here</span>
__author__ <span class="token operator">=</span> <span class="token string">&quot;a_little_rubbish&quot;</span>
__date__ <span class="token operator">=</span> <span class="token string">&quot;2018/11/22 8:18&quot;</span>

<span class="token comment">#import your model here</span>
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> time

<span class="token comment">#your class&amp;function here</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;waiting&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>t<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;done after {} seconds&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    tasks<span class="token operator">=</span><span class="token punctuation">[</span>get<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>get<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>get<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    loop<span class="token operator">=</span>asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#开始运行任务</span>
    <span class="token keyword">except</span> KeyboardInterrupt <span class="token keyword">as</span> e<span class="token punctuation">:</span><span class="token comment">#按下Ctrl+c的时候会触发</span>
        all_tasks<span class="token operator">=</span>asyncio<span class="token punctuation">.</span>Task<span class="token punctuation">.</span>all_tasks<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#获取所有的协程任务，没有传入，同过eventloop获取的</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> all_tasks<span class="token punctuation">:</span><span class="token comment">#迭代</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;cancel it!&quot;</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#取消任务，成功就返回True</span>
        loop<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#停止循环</span>
        loop<span class="token punctuation">.</span>run_forever<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#调用，否则会出错</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        loop<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#无论怎样都要关闭loop</span>
</code></pre></div><h3 id="嵌套协程的返回机制"><a href="#嵌套协程的返回机制" aria-hidden="true" class="header-anchor">#</a> 嵌套协程的返回机制</h3> <div class="danger custom-block"><p class="custom-block-title">WARNING</p> <p>留坑</p></div> <p><img src="https://upload-images.jianshu.io/upload_images/12620393-1c869fc45f491682.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="嵌套协程的返回机制"></p> <h3 id="在异步中使用同步代码"><a href="#在异步中使用同步代码" aria-hidden="true" class="header-anchor">#</a> 在异步中使用同步代码</h3> <div class="danger custom-block"><p class="custom-block-title">WARNING</p> <p>留坑</p></div> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#import your model here</span>
<span class="token keyword">import</span> asyncio<span class="token punctuation">,</span>time
<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor
<span class="token comment">#your class&amp;function here</span>
<span class="token keyword">def</span> <span class="token function">s</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;sleep &quot;</span><span class="token punctuation">,</span>t<span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>t<span class="token punctuation">)</span>
<span class="token comment">#在异步中使用同步代码</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    loop<span class="token operator">=</span>asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    executor<span class="token operator">=</span>ThreadPoolExecutor<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment">#创建线程池</span>
    tasks<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        task<span class="token operator">=</span>loop<span class="token punctuation">.</span>run_in_executor<span class="token punctuation">(</span>executor<span class="token punctuation">,</span>s<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token comment">#传入要添加的线程池，要运行的同步函数，参数，返回一个task对象</span>
        tasks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token comment">#添加任务列表</span>
    loop<span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>wait<span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="异步生命周期中的一些函数"><a href="#异步生命周期中的一些函数" aria-hidden="true" class="header-anchor">#</a> 异步生命周期中的一些函数</h3> <div class="danger custom-block"><p class="custom-block-title">WARNING</p> <p>留坑</p></div> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">callback</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;sleep {} times&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">stoploop</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">:</span>
    loop<span class="token punctuation">.</span>stop<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    loop<span class="token operator">=</span>asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    now<span class="token operator">=</span>loop<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    loop<span class="token punctuation">.</span>call_later<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>callback<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token comment">#过指定的时间就会运行某个函数，参数，根据时间排列先后顺序</span>
    loop<span class="token punctuation">.</span>call_at<span class="token punctuation">(</span>now<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">,</span>callback<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">#过指定的时间就会运行某个函数，参数，loop中的时间</span>
    loop<span class="token punctuation">.</span>call_soon<span class="token punctuation">(</span>callback<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token comment">#立即运行某个函数，参数，不会按时间排序一起开始运行</span>
    loop<span class="token punctuation">.</span>call_soon<span class="token punctuation">(</span>stoploop<span class="token punctuation">,</span>loop<span class="token punctuation">)</span><span class="token comment">#停止协程</span>
    loop<span class="token punctuation">.</span>call_soon_threadsafe<span class="token punctuation">(</span>callback<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment">#线程安全的运行某个函数</span>
    loop<span class="token punctuation">.</span>run_forever<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#别忘了这个</span>
</code></pre></div><h3 id="异步中的锁"><a href="#异步中的锁" aria-hidden="true" class="header-anchor">#</a> 异步中的锁</h3> <p>在异步中因为代码片执行到一定时间或执行了一定栈帧，GIL会自动释放，也可能导致线程(异步)不安全<br>
和多线程中一样我们需要使用锁来保证数据一致性</p> <div class="language-python extra-class"><pre class="language-python"><code>lock<span class="token operator">=</span>Lock<span class="token punctuation">(</span><span class="token punctuation">)</span>
cache<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#请求html的函数</span>
    <span class="token keyword">global</span> cache
    <span class="token keyword">async</span> <span class="token keyword">with</span> lock<span class="token punctuation">:</span><span class="token comment">#可以acquire也可以直接async with=with await</span>
        <span class="token keyword">if</span> arg <span class="token keyword">in</span> cache<span class="token punctuation">:</span>
            <span class="token keyword">return</span> cache<span class="token punctuation">[</span>arg<span class="token punctuation">]</span>
        <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment">#耗时操作</span>
        cache<span class="token punctuation">[</span><span class="token string">&quot;arg&quot;</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">2</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#使用这个请求，调用了这个解析函数</span>
    <span class="token keyword">await</span> parse<span class="token punctuation">(</span><span class="token string">&quot;didi&quot;</span><span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">reparse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#重新解析这个请求，再次调用这个解析函数，这样就对一个url调用了2次</span>
    <span class="token keyword">await</span> parse<span class="token punctuation">(</span><span class="token string">&quot;didi&quot;</span><span class="token punctuation">)</span>
<span class="token comment">#在这样使用时会导致协程不安全所以使用锁</span>
</code></pre></div><h3 id="aio异步爬虫"><a href="#aio异步爬虫" aria-hidden="true" class="header-anchor">#</a> aio异步爬虫</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token comment">#-*-coding:utf-8-*-</span>
<span class="token comment">#SettingCode here</span>
__author__ <span class="token operator">=</span> <span class="token string">&quot;a_little_rubbish&quot;</span>
__date__ <span class="token operator">=</span> <span class="token string">&quot;2018/11/23 13:27&quot;</span>

<span class="token comment">#import your model here</span>
<span class="token keyword">import</span> aiohttp
<span class="token keyword">import</span> aiomysql
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> re
<span class="token keyword">from</span> asyncio<span class="token punctuation">.</span>queues <span class="token keyword">import</span> Queue
<span class="token keyword">from</span> pyquery <span class="token keyword">import</span> PyQuery

stop<span class="token operator">=</span><span class="token boolean">False</span>

<span class="token comment">#your class&amp;function here</span>
start_url<span class="token operator">=</span><span class="token string">&quot;http://www.jobbole.com/&quot;</span>
waiting_urls<span class="token operator">=</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#未爬取的连接</span>
seen_urls<span class="token operator">=</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#已爬取过的连接，量大就用布隆过滤器</span>



<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#获取url</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">)</span> <span class="token keyword">as</span> the_response<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;url status:{}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>the_response<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> the_response<span class="token punctuation">.</span>status <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">201</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                data <span class="token operator">=</span><span class="token keyword">await</span> the_response<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> data
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">extract_urls</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">:</span>
    urls<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    pq<span class="token operator">=</span>PyQuery<span class="token punctuation">(</span>html<span class="token punctuation">)</span>
    <span class="token keyword">for</span> links <span class="token keyword">in</span> pq<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        url<span class="token operator">=</span>links<span class="token punctuation">.</span>attr<span class="token punctuation">(</span><span class="token string">&quot;href&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> url <span class="token keyword">and</span> url<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">&quot;http&quot;</span><span class="token punctuation">)</span> <span class="token keyword">and</span> url <span class="token keyword">not</span> <span class="token keyword">in</span> seen_urls<span class="token punctuation">:</span>
            urls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
            <span class="token keyword">await</span> waiting_urls<span class="token punctuation">.</span>put<span class="token punctuation">(</span>url<span class="token punctuation">)</span>



<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">init_urls</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#用作启动</span>
    html<span class="token operator">=</span> <span class="token keyword">await</span> fetch<span class="token punctuation">(</span>url<span class="token punctuation">,</span>session<span class="token punctuation">)</span>
    <span class="token keyword">await</span> extract_urls<span class="token punctuation">(</span>html<span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">article_handler</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span>session<span class="token punctuation">,</span>pool<span class="token punctuation">)</span><span class="token punctuation">:</span>
    html<span class="token operator">=</span><span class="token keyword">await</span> fetch<span class="token punctuation">(</span>url<span class="token punctuation">,</span>session<span class="token punctuation">)</span>
    seen_urls<span class="token punctuation">.</span>add<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
    <span class="token keyword">await</span> extract_urls<span class="token punctuation">(</span>html<span class="token punctuation">)</span>
    pq<span class="token operator">=</span>PyQuery<span class="token punctuation">(</span>html<span class="token punctuation">)</span>
    tittle<span class="token operator">=</span>pq<span class="token punctuation">(</span><span class="token string">&quot;tittle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">with</span> pool<span class="token punctuation">.</span>acquire<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> cur<span class="token punctuation">:</span>
            <span class="token keyword">await</span> cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">&quot;INSERT INTO tittle VALUE {}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>tittle<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;ok +1&quot;</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">consumer</span><span class="token punctuation">(</span>pool<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">with</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token keyword">not</span> stop<span class="token punctuation">:</span>
            url<span class="token operator">=</span> <span class="token keyword">await</span> waiting_urls<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;get {}&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> re<span class="token punctuation">.</span>match<span class="token punctuation">(</span><span class="token string">&quot;http://.*?jobbole.com/\d+/&quot;</span><span class="token punctuation">,</span>url<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> url <span class="token keyword">not</span> <span class="token keyword">in</span> seen_urls<span class="token punctuation">:</span>
                    asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>article_handler<span class="token punctuation">(</span>url<span class="token punctuation">,</span>session<span class="token punctuation">,</span>pool<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> url <span class="token keyword">not</span> <span class="token keyword">in</span> seen_urls<span class="token punctuation">:</span>
                    asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>init_urls<span class="token punctuation">(</span>url<span class="token punctuation">,</span>session<span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">:</span>
    pool <span class="token operator">=</span> <span class="token keyword">await</span> aiomysql<span class="token punctuation">.</span>create_pool<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">3306</span><span class="token punctuation">,</span> user<span class="token operator">=</span><span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">&quot;1118&quot;</span><span class="token punctuation">,</span> db<span class="token operator">=</span><span class="token string">&quot;aiosql&quot;</span><span class="token punctuation">,</span> loop<span class="token operator">=</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
                                charset<span class="token operator">=</span><span class="token string">&quot;utf8&quot;</span><span class="token punctuation">,</span> autocommit<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">with</span> aiohttp<span class="token punctuation">.</span>ClientSession<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>
        html<span class="token operator">=</span> <span class="token keyword">await</span> fetch<span class="token punctuation">(</span>start_url<span class="token punctuation">,</span>session<span class="token punctuation">)</span>
        seen_urls<span class="token punctuation">.</span>add<span class="token punctuation">(</span>start_url<span class="token punctuation">)</span>
        <span class="token keyword">await</span> extract_urls<span class="token punctuation">(</span>html<span class="token punctuation">)</span>
    asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>consumer<span class="token punctuation">(</span>pool<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    loop<span class="token operator">=</span>asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    asyncio<span class="token punctuation">.</span>ensure_future<span class="token punctuation">(</span>main<span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">)</span>
    loop<span class="token punctuation">.</span>run_forever<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="异步插入数据库"><a href="#异步插入数据库" aria-hidden="true" class="header-anchor">#</a> 异步插入数据库</h3> <p>在scrapy中异步插入mysql看<a href>这里</a></p> <div class="danger custom-block"><p class="custom-block-title">WARNING</p> <p>留坑</p></div> <h2 id="后续将持续更新"><a href="#后续将持续更新" aria-hidden="true" class="header-anchor">#</a> 后续将持续更新</h2> <div id="vcomments"></div></div> <!----> <!----> <!----> <div class="page-edit" data-v-cdcae5a4><!----> <div class="last-updated" data-v-cdcae5a4><span class="prefix" data-v-cdcae5a4>Last Updated: </span> <span class="time" data-v-cdcae5a4>12/29/2019, 3:00:55 PM</span></div></div> <div class="page-nav" data-v-cdcae5a4><p class="inner" data-v-cdcae5a4><!----> <span class="next" data-v-cdcae5a4><a href="/blog/back/python/python实战提高.html" data-v-cdcae5a4>
          python实战提高
        </a>
        →
      </span></p></div> </div> <div class="valine-wrapper" data-v-63f18ac0><div id="valine" style="display:;" data-v-63f18ac0></div></div> <!----> <!----> <div class="back-to-ceiling" style="right:1rem;bottom:3rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-41016a8b data-v-41016a8b><i class="iconfont reco-up" data-v-41016a8b></i></div></div></div></div>
    <script src="/assets/js/app.64171550.js" defer></script><script src="/assets/js/68.3b9433a6.js" defer></script><script src="/assets/js/38.34e99c36.js" defer></script>
  </body>
</html>
