<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Scrapy(old) | ä¼šèµ°è·¯çš„ä¸‰ç™¾å—</title>
    <meta name="description" content="å¹´è½»äººçš„åšå®¢">
    <link rel="icon" href="/logo1.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.d22626bb.css" as="style"><link rel="preload" href="/assets/js/app.64171550.js" as="script"><link rel="preload" href="/assets/js/6.9305fa77.js" as="script"><link rel="prefetch" href="/assets/js/10.f30e4bf5.js"><link rel="prefetch" href="/assets/js/100.14a8b555.js"><link rel="prefetch" href="/assets/js/101.9e257240.js"><link rel="prefetch" href="/assets/js/11.c050169c.js"><link rel="prefetch" href="/assets/js/12.9abd0678.js"><link rel="prefetch" href="/assets/js/13.ca763ee5.js"><link rel="prefetch" href="/assets/js/14.69f05fca.js"><link rel="prefetch" href="/assets/js/15.db5225be.js"><link rel="prefetch" href="/assets/js/16.c6de58f6.js"><link rel="prefetch" href="/assets/js/17.a33727a2.js"><link rel="prefetch" href="/assets/js/18.78f0824a.js"><link rel="prefetch" href="/assets/js/19.20a4f3cf.js"><link rel="prefetch" href="/assets/js/20.15fb9aec.js"><link rel="prefetch" href="/assets/js/21.c2410e24.js"><link rel="prefetch" href="/assets/js/22.6423d49a.js"><link rel="prefetch" href="/assets/js/23.1b0b2120.js"><link rel="prefetch" href="/assets/js/24.93132bac.js"><link rel="prefetch" href="/assets/js/25.a334198a.js"><link rel="prefetch" href="/assets/js/26.c1c7aaa3.js"><link rel="prefetch" href="/assets/js/27.2c86a0cd.js"><link rel="prefetch" href="/assets/js/28.a9d5d0ae.js"><link rel="prefetch" href="/assets/js/29.82f2e489.js"><link rel="prefetch" href="/assets/js/3.465cd447.js"><link rel="prefetch" href="/assets/js/30.d0c8250c.js"><link rel="prefetch" href="/assets/js/31.e6286844.js"><link rel="prefetch" href="/assets/js/32.116769da.js"><link rel="prefetch" href="/assets/js/33.38e22b91.js"><link rel="prefetch" href="/assets/js/34.21d15ece.js"><link rel="prefetch" href="/assets/js/35.53517849.js"><link rel="prefetch" href="/assets/js/36.9b848dcf.js"><link rel="prefetch" href="/assets/js/37.bf3574bb.js"><link rel="prefetch" href="/assets/js/38.34e99c36.js"><link rel="prefetch" href="/assets/js/39.10a54121.js"><link rel="prefetch" href="/assets/js/4.9d750d27.js"><link rel="prefetch" href="/assets/js/40.0ead9dc2.js"><link rel="prefetch" href="/assets/js/41.16bfab2f.js"><link rel="prefetch" href="/assets/js/42.b0388f8b.js"><link rel="prefetch" href="/assets/js/43.1d51bbcb.js"><link rel="prefetch" href="/assets/js/44.9e15a8ac.js"><link rel="prefetch" href="/assets/js/45.c9a7ee30.js"><link rel="prefetch" href="/assets/js/46.0821d6b3.js"><link rel="prefetch" href="/assets/js/47.fdd4b2c4.js"><link rel="prefetch" href="/assets/js/48.c86a3241.js"><link rel="prefetch" href="/assets/js/49.29d7cdaf.js"><link rel="prefetch" href="/assets/js/5.b5540d72.js"><link rel="prefetch" href="/assets/js/50.88cae993.js"><link rel="prefetch" href="/assets/js/51.39b0672d.js"><link rel="prefetch" href="/assets/js/52.47b9c89c.js"><link rel="prefetch" href="/assets/js/53.561866dc.js"><link rel="prefetch" href="/assets/js/54.44ad8aef.js"><link rel="prefetch" href="/assets/js/55.999cd3f5.js"><link rel="prefetch" href="/assets/js/56.0fc25a14.js"><link rel="prefetch" href="/assets/js/57.fbeec51d.js"><link rel="prefetch" href="/assets/js/58.c2c3e960.js"><link rel="prefetch" href="/assets/js/59.388b8a2f.js"><link rel="prefetch" href="/assets/js/60.3bab7106.js"><link rel="prefetch" href="/assets/js/61.fab74e1f.js"><link rel="prefetch" href="/assets/js/62.b8451d9d.js"><link rel="prefetch" href="/assets/js/63.1ea19cc7.js"><link rel="prefetch" href="/assets/js/64.21f37b67.js"><link rel="prefetch" href="/assets/js/65.79da4678.js"><link rel="prefetch" href="/assets/js/66.2276f1ea.js"><link rel="prefetch" href="/assets/js/67.cf3e97e4.js"><link rel="prefetch" href="/assets/js/68.3b9433a6.js"><link rel="prefetch" href="/assets/js/69.a6723b19.js"><link rel="prefetch" href="/assets/js/7.8235c05c.js"><link rel="prefetch" href="/assets/js/70.eff0cc02.js"><link rel="prefetch" href="/assets/js/71.577ad016.js"><link rel="prefetch" href="/assets/js/72.ee1b8084.js"><link rel="prefetch" href="/assets/js/73.ce23853b.js"><link rel="prefetch" href="/assets/js/74.e51d0dc7.js"><link rel="prefetch" href="/assets/js/75.3fbf6e41.js"><link rel="prefetch" href="/assets/js/76.1ad79723.js"><link rel="prefetch" href="/assets/js/77.05aaa2f4.js"><link rel="prefetch" href="/assets/js/78.9e4bf317.js"><link rel="prefetch" href="/assets/js/79.028f9c41.js"><link rel="prefetch" href="/assets/js/8.a4265244.js"><link rel="prefetch" href="/assets/js/80.a83e9fee.js"><link rel="prefetch" href="/assets/js/81.e20ef630.js"><link rel="prefetch" href="/assets/js/82.0a2c28d1.js"><link rel="prefetch" href="/assets/js/83.84f22d3a.js"><link rel="prefetch" href="/assets/js/84.8c0c443d.js"><link rel="prefetch" href="/assets/js/85.1473a2e2.js"><link rel="prefetch" href="/assets/js/86.4683653f.js"><link rel="prefetch" href="/assets/js/87.9507aa61.js"><link rel="prefetch" href="/assets/js/88.77ce595e.js"><link rel="prefetch" href="/assets/js/89.d25806a8.js"><link rel="prefetch" href="/assets/js/9.56b90d44.js"><link rel="prefetch" href="/assets/js/90.231b245f.js"><link rel="prefetch" href="/assets/js/91.cb1ec410.js"><link rel="prefetch" href="/assets/js/92.10cedbd9.js"><link rel="prefetch" href="/assets/js/93.575cc043.js"><link rel="prefetch" href="/assets/js/94.9233e13a.js"><link rel="prefetch" href="/assets/js/95.fafa9bc4.js"><link rel="prefetch" href="/assets/js/96.8b941223.js"><link rel="prefetch" href="/assets/js/97.49080105.js"><link rel="prefetch" href="/assets/js/98.82d1cc72.js"><link rel="prefetch" href="/assets/js/99.d78b0b9a.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.0cd5f832.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d22626bb.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><div><header id="navbarWrapper" class="navbar"><div class="sidebar-button"><i class="iconfont reco-menu"></i></div> <a href="/" class="home-link router-link-active"><img src="/head3.png" alt="ä¼šèµ°è·¯çš„ä¸‰ç™¾å—" class="logo"> <span class="site-name">ä¼šèµ°è·¯çš„ä¸‰ç™¾å—</span></a> <div class="links" style="max-width:nullpx;"><div class="side-search-wrapper"><div class="search-box" data-v-1b2e3b29><input aria-label="Search" autocomplete="off" spellcheck="false" value="" data-v-1b2e3b29> <i class="iconfont reco-search" data-v-1b2e3b29></i> <!----></div></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      åˆ†ç±»
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/backEnd.html" class="nav-link"><i class="iconfont undefined"></i>
  åç«¯
</a></li><li class="dropdown-item"><!----> <a href="/categories/frontEnd.html" class="nav-link"><i class="iconfont undefined"></i>
  å‰ç«¯
</a></li><li class="dropdown-item"><!----> <a href="/categories/bigData.html" class="nav-link"><i class="iconfont undefined"></i>
  å¤§æ•°æ®
</a></li><li class="dropdown-item"><!----> <a href="/categories/Distributed.html" class="nav-link"><i class="iconfont undefined"></i>
  åˆ†å¸ƒå¼
</a></li><li class="dropdown-item"><!----> <a href="/categories/life.html" class="nav-link"><i class="iconfont undefined"></i>
  æ—¥è®°
</a></li></ul></div></div><div class="nav-item"><a href="/tags/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tags
</a></div><div class="nav-item"><a href="/categories/article.html" class="nav-link"><i class="iconfont reco-up"></i>
  Library
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/about.html" class="nav-link"><i class="iconfont reco-account"></i>
  about me
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/04777e91e2ef" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-jianshu"></i>
  ç®€ä¹¦
  </a></div><div class="nav-item"><a href="https://github.com/Castleeee" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  </a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><div class="side-search-wrapper"><div class="search-box" data-v-1b2e3b29><input aria-label="Search" autocomplete="off" spellcheck="false" value="" data-v-1b2e3b29> <i class="iconfont reco-search" data-v-1b2e3b29></i> <!----></div></div> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      åˆ†ç±»
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/backEnd.html" class="nav-link"><i class="iconfont undefined"></i>
  åç«¯
</a></li><li class="dropdown-item"><!----> <a href="/categories/frontEnd.html" class="nav-link"><i class="iconfont undefined"></i>
  å‰ç«¯
</a></li><li class="dropdown-item"><!----> <a href="/categories/bigData.html" class="nav-link"><i class="iconfont undefined"></i>
  å¤§æ•°æ®
</a></li><li class="dropdown-item"><!----> <a href="/categories/Distributed.html" class="nav-link"><i class="iconfont undefined"></i>
  åˆ†å¸ƒå¼
</a></li><li class="dropdown-item"><!----> <a href="/categories/life.html" class="nav-link"><i class="iconfont undefined"></i>
  æ—¥è®°
</a></li></ul></div></div><div class="nav-item"><a href="/tags/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tags
</a></div><div class="nav-item"><a href="/categories/article.html" class="nav-link"><i class="iconfont reco-up"></i>
  Library
</a></div><div class="nav-item"><a href="/timeLine/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><a href="/about.html" class="nav-link"><i class="iconfont reco-account"></i>
  about me
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/04777e91e2ef" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-jianshu"></i>
  ç®€ä¹¦
  </a></div><div class="nav-item"><a href="https://github.com/Castleeee" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  </a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><!----></p> <ul class="sidebar-group-items"><li><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#setting-å‘½ä»¤" class="sidebar-link">Setting&amp;å‘½ä»¤</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#spider" class="sidebar-link">Spider</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#æ™®é€šspider" class="sidebar-link">æ™®é€šspider</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#crawlspider" class="sidebar-link">CrawlSpider</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#xpathå’Œcssé€‰æ‹©å™¨" class="sidebar-link">Xpathå’ŒCssé€‰æ‹©å™¨</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#ä½¿ç”¨itemloader" class="sidebar-link">ä½¿ç”¨Itemloader</a></li></ul></li><li><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#item" class="sidebar-link">Item</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#å®šä¹‰itemçš„filed" class="sidebar-link">å®šä¹‰itemçš„Filed</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#è¾“å…¥è¾“å‡ºå¤„ç†å™¨" class="sidebar-link">è¾“å…¥è¾“å‡ºå¤„ç†å™¨</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#django-scrapy-item" class="sidebar-link">django scrapy item</a></li></ul></li><li><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#pipline" class="sidebar-link">Pipline</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#å›¾ç‰‡pipeline" class="sidebar-link">å›¾ç‰‡Pipeline</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#æ’å…¥sqlæ•°æ®åº“" class="sidebar-link">æ’å…¥sqlæ•°æ®åº“</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#å¼‚æ­¥æ’å…¥sql" class="sidebar-link">å¼‚æ­¥æ’å…¥sql</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#æ’å…¥mongo" class="sidebar-link">æ’å…¥mongo</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#ä¿å­˜ä¸ºjson" class="sidebar-link">ä¿å­˜ä¸ºjson</a></li></ul></li><li><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#middleware" class="sidebar-link">Middleware</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#éšæœºuser-agent" class="sidebar-link">éšæœºUser-Agent</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#ipä»£ç†" class="sidebar-link">IPä»£ç†</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#ä½¿ç”¨cookie" class="sidebar-link">ä½¿ç”¨cookie</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#è‡ªåŠ¨é‡è¯•ä¸­é—´ä»¶" class="sidebar-link">è‡ªåŠ¨é‡è¯•ä¸­é—´ä»¶</a></li><li class="sidebar-sub-header"><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#é›†æˆselenium" class="sidebar-link">é›†æˆselenium</a></li></ul></li><li><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#schduler-other" class="sidebar-link">Schduler&amp;Other</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/back/python/scrapy%E7%9B%B8%E5%85%B3.html#schdulerå»é‡æœºåˆ¶" class="sidebar-link">Schdulerå»é‡æœºåˆ¶</a></li></ul></li></ul></div></li></ul> </div> <div class="page" data-v-cdcae5a4> <div class="page-title" data-v-cdcae5a4><h1 data-v-cdcae5a4>Scrapy(old)</h1> <hr data-v-cdcae5a4> <div data-v-2c25cede data-v-cdcae5a4><i class="iconfont reco-account" data-v-2c25cede><span data-v-2c25cede>ä¼šèµ°è·¯çš„ä¸‰ç™¾å—</span></i> <i class="iconfont reco-date" data-v-2c25cede><span data-v-2c25cede>7/13/2018</span></i> <!----> <i class="iconfont reco-tag tags" data-v-2c25cede><span class="tag-item" data-v-2c25cede>
      pythonğŸ
    </span><span class="tag-item" data-v-2c25cede>
      scrapy
    </span><span class="tag-item" data-v-2c25cede>
      åç«¯
    </span><span class="tag-item" data-v-2c25cede>
      å¼‚æ­¥
    </span><span class="tag-item" data-v-2c25cede>
      æ‰€æœ‰æ–‡ç« 
    </span><span class="tag-item" data-v-2c25cede>
      çˆ¬è™«ğŸ•·
    </span><span class="tag-item" data-v-2c25cede>
      è¿›é˜¶
    </span></i></div></div> <div class="content" data-v-cdcae5a4><div align="center"><h1>Scrapyä»‹ç»</h1></div> <div align="center"><h3>å¼‚æ­¥</h3>
engineå¼‚æ­¥è°ƒç”¨ç¼©çŸ­äº‹ä»¶
<h3>äº‹ä»¶å¾ªç¯</h3>
å¯¹è±¡ä¼ é€’+äº‹ä»¶å¾ªç¯<br>
spiderâ€”&gt;itemâ€”&gt;pipline
<h3>å®šåˆ¶åŒ–</h3>
å®šåˆ¶çš„piplineé›†ä¸­å­˜å‚¨<br>
selector+xpathå®šä½çˆ¬å–
<img src="/assets/img/scrapy_architecture.e2954a38.png"></div> <h2 id="setting-å‘½ä»¤"><a href="#setting-å‘½ä»¤" aria-hidden="true" class="header-anchor">#</a> Setting&amp;å‘½ä»¤</h2> <h3>ç¯å¢ƒ</h3> <p>è®¾ç½®å¥½ç¯å¢ƒpythonè·¯å¾„ç­‰ç­‰<br>
ä»wheelæ‰¾</p> <ul><li>pywin32</li> <li>pillow</li> <li>tiwsted</li></ul> <div class="danger custom-block"><p class="custom-block-title">WARNING</p> <p>ä¸èƒ½åªè£…pymysqléœ€è¦MYSQLdb<br>
å®‰è£…MYSQLdbä¹Ÿå°±æ˜¯mydqlclientå’Œpymysql<br>
å¦‚æœå¤±è´¥apt-get install python-devel mysql-devel</p></div> <h3>httpçŠ¶æ€ç </h3> <pre><code>      codeè¯´æ˜
      200è¯·æ±‚è¢«æˆåŠŸå¤„ç†
      301/302æ°¸ä¹…æ€§é‡å®šå‘/ä¸´æ—¶æ€§é‡å®šå‘
      403æ²¡æœ‰æƒé™è®¿é—®
      404è¡¨ç¤ºæ²¡æœ‰å¯¹åº”çš„èµ„æº
      500æœåŠ¡å™¨é”™è¯¯
      503æœåŠ¡å™¨åœæœºæˆ–æ­£åœ¨ç»´æŠ¤
</code></pre> <h3>å‘½ä»¤è¡Œ</h3> <pre><code>      scrapy startproject name
      #æ–°å»ºä¸€ä¸ªå·¥ç¨‹,å¹¶cd è¿›ç›®å½•ä¸­å»
      scrapy genspider [-t crawl] name xxx.com
      #ç”Ÿæˆä¸€ä¸ªxxxçˆ¬è™«ï¼Œæ³¨æ„åŸŸååªéœ€è¦www.xxx.comå°±è¡ŒäºŒçº§åŸŸåç›´æ¥å¡«
      ä¸å¡«å†™å°±æ˜¯é»˜è®¤çš„ spider å¡«å†™æœ€å¸¸ç”¨çš„å°±æ˜¯crawl
      scrapy crawl spidername
      #å‘½ä»¤è¡Œè¿è¡Œspidernameçˆ¬è™«
</code></pre> <div class="warning custom-block"><p class="custom-block-title">WARNING</p> <p>ä½ æ–°å»ºçš„çˆ¬è™«åå­—ä¸èƒ½ä¸ç½‘ç«™åå­—ï¼Œé¡¹ç›®åå­—ç›¸åŒï¼Œä½ çš„åå­—ä¼šåœ¨spiderä¸­æœ‰ä¸€ä¸ªå˜é‡è¡¨ç¤º</p></div> <h3>pycharmå¯åŠ¨</h3>
æ–°å»ºä¸€ä¸ªpyæ–‡ä»¶å†™å…¥å¦‚ä¸‹å†…å®¹ï¼Œåœ¨pycharmä¸­ä½œå¦‚ä¸‹è®¾ç½®
<div class="language-py extra-class"><pre class="language-py"><code><span class="token comment">#import your model here</span>
<span class="token keyword">from</span> scrapy <span class="token keyword">import</span> cmdline
<span class="token comment">#your class&amp;function here</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    cmdline<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;scrapy&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;crawl&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;çˆ¬è™«åå­—&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

</code></pre></div><div align="center"><img src="/assets/img/starter.70a190c7.png"></div> <p>è¿™æ ·ç›´æ¥F5å°±å¯ä»¥è¿è¡Œæ•´ä¸ªç¨‹åºäº†
</p><h3>ä¿®æ”¹setting</h3><p></p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">import</span> os<span class="token punctuation">,</span>sys
project_dir<span class="token operator">=</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#è·å–äº†å½“å‰æ–‡ä»¶ä¹Ÿå°±æ˜¯settingçš„ç›®å½•</span>
IMAGES_STORE <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>project_dir<span class="token punctuation">,</span><span class="token string">&quot;images&quot;</span><span class="token punctuation">)</span><span class="token comment">#è®¾ç½®imageçš„å­˜å‚¨æ–‡ä»¶å¤¹ä¸ºå½“å‰ç›®å½•ä¸‹çš„image</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">(oï¾Ÿvï¾Ÿ)ãƒ</p> <p>æŠŠsettingä¸­çš„ROBOTSTXT_OBEY = Trueè®¾ç½®ä¸ºFalseä¸ç„¶ä¼šå¾ˆè ¢</p></div> <p>æ›´å¤šè®¾ç½®çš„ä½œç”¨åœ¨<a href="#settingçš„ä¸€äº›å¸¸ç”¨">è¿™é‡Œ</a></p> <h2 id="spider"><a href="#spider" aria-hidden="true" class="header-anchor">#</a> Spider</h2> <h3 id="æ™®é€šspider"><a href="#æ™®é€šspider" aria-hidden="true" class="header-anchor">#</a> æ™®é€šspider</h3> <p>æ–°å»ºäº†ä¸€ä¸ªspideræ˜¯è¿™æ ·çš„<br></p><div align="center"><img src="/assets/img/basicspider.d326d81b.png" style="height:250px"></div><p></p> <p>è¿™ä¸ªç±»æ¥ç»§æ‰¿äº†Spider</p> <ul><li>nameå°±æ˜¯çˆ¬è™«åå­—</li> <li>allow_dominså°±æ˜¯å…è®¸çˆ¬å“ªä¸ªåŸŸåçš„èŒƒå›´</li> <li>start_urlsæ˜¯ä¸€ä¸ªå¼€å§‹çˆ¬å–é‚£äº›urlçš„åˆ—è¡¨</li></ul> <p>parse1()-&gt;parse2()-&gt;...-&gt;trans()
ä¸€å¼€å§‹ä¼šåˆå§‹çš„urlï¼Œç„¶åæŠŠresponseä¼ ç»™parse1ï¼Œparse1è¿›è¡Œå¤„ç†åœ¨ä¼ ç»™parse2æœ€åç»™ä¸€ä¸ªå‡½æ•°(trans)å½¢æˆitemä¼ ç»™pipline
</p><h4>parseå‡½æ•°</h4>
å®šä¹‰parseå‡½æ•°ï¼Œé»˜è®¤æ¥å—ä¸€ä¸ªresponseå¯¹è±¡<br>
responseå¯¹è±¡:<br><p></p> <div align="center"><img src="/assets/img/resobject.3c792678.png"></div>
è¿™ä¸ªå¯¹è±¡çš„åŸºæœ¬çš„urlï¼Œtextï¼Œstatusï¼Œencodingï¼Œheadersæ˜¯åŸºæœ¬å±æ€§ã€‚é‡ç‚¹è¯´ä¸€ä¸‹metaï¼Œselectorå’Œrequest
<br>requestæ˜¯ä¸€ä¸ªRequestå¯¹è±¡ï¼Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„è¯·æ±‚ä¿¡æ¯ï¼Œè§£æå»é‡æ¨¡å—ä¸­å°†è¦ä½¿ç”¨çš„å°±æ˜¯è¿™ä¸ªrequestä¸­çš„ä¿¡æ¯ã€‚<br>
åœ¨*å¼‚æ­¥ä»£ç *ä¸­ä¸è¦ä½¿ç”¨åŒæ­¥ä»£ç ï¼Œä¼šå¯¼è‡´é˜»å¡æ€§èƒ½ä¸‹é™ä¸¥é‡ã€‚<br>
è‡ªåŠ¨å¾€ä¸‹çˆ¬å–<br> <p>ä»è¿™ä¸ªresponseä¸­æå–å‡ºè¿˜æœ‰éœ€è¦çˆ¬å–çš„urlæˆ‘ä»¬éœ€è¦ç»§ç»­è®¿é—®ï¼Œè¿™æ—¶å€™æˆ‘ä»¬è¦ç”¨Requestå‡½æ•°<br></p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">from</span> scrapy <span class="token keyword">import</span> Request
<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
  response<span class="token punctuation">.</span>meta<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token comment">#è¿™æ ·å°±å’Œå­—å…¸ä¸€æ ·å–å‡ºäº†v</span>
  process<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">yield</span> Request<span class="token punctuation">(</span>url<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span>meta<span class="token operator">=</span><span class="token punctuation">{</span>k<span class="token punctuation">:</span>v<span class="token punctuation">}</span><span class="token punctuation">,</span>callback<span class="token operator">=</span>self<span class="token punctuation">.</span>func<span class="token punctuation">)</span>
</code></pre></div><p>è¿™æ—¶å€™ä¼šyieldä¸€ä¸ªRequestå¯¹è±¡å‡ºå»ï¼Œè¯·æ±‚ä¸€ä¸‹ä¼ å…¥çš„urlï¼ŒæŠŠæœ¬æ¬¡processè§£æçš„ä¸œè¥¿ä½œä¸ºä¸€ä¸ª<em>å­—å…¸</em>ä¼ ç»™meta,è¿™æ ·å°±å®ç°äº†è§£æå†…å®¹çš„ä¼ é€’</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>å¯ä»¥ç›´æ¥æŒ‡å‘self,è¿™æ ·è¿™ä¸ªè¯·æ±‚è¿˜ä¼šå›æ¥è°ƒç”¨è‡ªèº«ï¼Œå½¢æˆä¸€ä¸ªéšå¼é€’å½’ã€‚<br>
æ³¨æ„é€’å½’çš„è¾¹ç•Œæ¡ä»¶å³urlçˆ¬å–åˆ°ä»€ä¹ˆæ—¶å€™è¦ä¼ å…¥transå‡½æ•°å­˜å…¥<br>
å¦åˆ™å°±ä¼šä¸€ç›´æ‰§è¡Œä¸‹å»ç›´åˆ°æ‰€æœ‰çš„urléƒ½è®¿é—®è¿‡äº†</p></div> <p>æœ€å¸¸è§çš„æƒ…å†µå³è§£æä¸€ä¸ªé¡µé¢ï¼Œæ‹¿ä¸€äº›å†…å®¹åœ¨metaä¸­ä¼ é€’ç»™transå‡½æ•°æˆ–ä¸‹ä¸€ä¸ªparseï¼Œç„¶åå†è¿™ä¸ªé¡µé¢é‡Œçš„æŸäº›url(æ¯”å¦‚ä¸‹ä¸€é¡µç­‰)ç»§ç»­Requestè°ƒç”¨è‡ªèº«
<br>Requestçš„å‚æ•°</p> <ul><li>urlæ˜¯è¯·æ±‚çš„åœ°å€</li> <li>callback è¯·æ±‚å®Œä¹‹åçš„å›è°ƒï¼Œä¼ å…¥ä¸€ä¸ªresponse</li> <li>method='GET' è¯·æ±‚æ–¹æ³•Get/Post</li> <li>headers è¯·æ±‚å¤´</li> <li>body è¯·æ±‚body</li> <li>cookies ä½¿ç”¨å“ªä¸ªcookie</li> <li>meta metaç”¨æ¥ä¼ é€’å€¼</li> <li>encoding='utf-8' ç¼–ç </li> <li>priority=0 åœ¨schedulerä¸­çš„ä¼˜å…ˆçº§</li> <li>dont_filter=False è¦ä¸è¦è¢«schedulerå»é‡</li></ul> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>headerï¼Œcookieï¼ŒUAå¯ä»¥åœ¨è¿™é‡ŒåŠ ä¹Ÿå¯ä»¥åœ¨middlewareé›†ä¸­åŠ åœ¨è¿™é‡ŒåŠ åªä¼šå¯¹è¿™ä¸ªRequestå‘èµ·çš„è¯·æ±‚æœ‰æ•ˆå…¶ä»–Requestä½¿ç”¨middlewareçš„</p></div> <h4>å½¢æˆItemä¼ é€’ç»™pipline</h4> <p>trans()<br>
å®šä¹‰ä¸€ä¸ªè§£æå‡½æ•°,è¿™ä¸ªå‡½æ•°æ¥å—ä¸€ä¸ªresponse,å®ƒä¼šè§£æresponseä¸­çš„å†…å®¹ï¼Œåˆ©ç”¨Xpathæˆ–è€…CssSelectoré€‰æ‹©è‡ªå·±æƒ³è¦çš„å†…å®¹
æœ€åå½¢æˆä¸€äº›å˜é‡ï¼Œå°†è¿™äº›å˜é‡é€šè¿‡item['k']æˆ–Itemloaderèµ‹å€¼ç»™itemæœ€åyieldå‡ºå»
</p><h3>ä½¿ç”¨item</h3><p></p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token comment">#æ–‡ä»¶é¡¶éƒ¨å¼•å…¥</span>
<span class="token keyword">from</span> engine<span class="token punctuation">.</span>items <span class="token keyword">import</span> MyItem
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
item<span class="token operator">=</span>MyItem<span class="token punctuation">(</span><span class="token punctuation">)</span>
item<span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">]</span><span class="token operator">=</span>å˜é‡a
item<span class="token punctuation">[</span><span class="token string">'y'</span><span class="token punctuation">]</span><span class="token operator">=</span>å˜é‡b
<span class="token keyword">yield</span> item

</code></pre></div><p>è¿™ä¸ªitemä¼šä¼ åˆ°piplineä¸­å»</p> <h3 id="crawlspider"><a href="#crawlspider" aria-hidden="true" class="header-anchor">#</a> CrawlSpider</h3> <p>å…¨ç«™çˆ¬è™«éœ€è¦æ³¨æ„çš„åœ°æ–¹æœ‰å»é‡ï¼Œurlå¤„ç†ï¼ŒRequestè½¬å‘<br>
ä¸å†éœ€è¦è‡ªå·±å¯»æ‰¾urlï¼Œscrapyä¼šè‡ªå·±å¤„ç†é€šè¿‡<em>Rule</em>è¿›è¡Œç­›é€‰ï¼Œç¬¦åˆallow_dominså’Œruleçš„å°±ä¼šè‡ªåŠ¨æŠ“å–ï¼Œç„¶åè§£æè¯¥é¡µé¢æ‰€æœ‰åŒ…å«çš„url
,ç¬¦åˆæ¡ä»¶çš„ç»§ç»­é€’å½’Ruleä½¿ç”¨æ­£åˆ™è¿›è¡Œå®šä¹‰
æ–°å»ºä¸€ä¸ªä¹‹åæ˜¯è¿™æ ·çš„(ä¸ºäº†ä¾¿äºè®²è§£æˆ‘æ”¹è¿‡äº†)
</p><div align="center"><img src="/assets/img/crawl.2189c92b.png"></div>
è¿™é‡Œruleæ˜¯ä¸€ä¸ªLinkExtractorå®šä¹‰çš„ç±»<p></p> <ul><li>allow(æ­£åˆ™åŒ¹é…ç¬¦åˆçš„å°±è¯·æ±‚)</li> <li>callback(è¯·æ±‚ä¹‹åä¼ å…¥å“ªä¸ªå‡½æ•°,ä¸€èˆ¬æ˜¯ä¼ å…¥è¦è¿›è¡Œè§£æçš„å‡½æ•°)</li> <li>follow(ç¬¦åˆæœ¬è§„åˆ™çš„é¡µé¢æ˜¯å¦ç»§ç»­å¾€ä¸‹çˆ¬)</li> <li>uniqueï¼ˆbooleanï¼‰æ˜¯å¦å»é‡</li> <li>attrsï¼ˆlistï¼‰åœ¨æŸ¥æ‰¾è¦æå–çš„é“¾æ¥æ—¶åº”è¯¥è€ƒè™‘çš„å±æ€§æˆ–å±æ€§åˆ—è¡¨ï¼ˆä»…é€‚ç”¨äºå‚æ•°ä¸­æŒ‡å®šçš„é‚£äº›æ ‡ç­¾tags ï¼‰ã€‚é»˜è®¤ä¸º('href',)</li></ul> <h3 id="xpathå’Œcssé€‰æ‹©å™¨"><a href="#xpathå’Œcssé€‰æ‹©å™¨" aria-hidden="true" class="header-anchor">#</a> Xpathå’ŒCssé€‰æ‹©å™¨</h3> <h3>è¯­æ³•çœ‹<a href="/çˆ¬è™«.html#xpath-cssselector">è¿™é‡Œ</a></h3> <BR></BR> <p>ä»ç½‘é¡µæºä»£ç ä¸­æå–è‡ªå·±æƒ³è¦çš„å­—æ®µå°±è¦ç”¨scrapyä¸­çš„æå–å™¨(scrapyçš„æå–å™¨é€Ÿåº¦å¿«ï¼Œå¼‚æ­¥æ“ä½œå‹å¥½)selector
<br></p> <ul><li>selector=response.css('css selector')<br></li> <li>selector=response.xpath('xpath')<br></li></ul> <p>æ‹¿å‡ºæ¥çš„æ˜¯ä¸€selectorå¯¹è±¡æˆ–è€…æ˜¯SelectorList(åœ¨ç”±å¤šä¸ªèŠ‚ç‚¹æƒ…å†µä¸‹),è°ƒç”¨selector.extract[0],è·å–å†…å®¹
è¿™ä¸ªæ–¹æ³•ç­‰ä»·äºselector.extract_first()
è¿™é‡Œæ˜¯å†çˆ¬ç®€ä¹¦çš„æ—¶å€™ï¼Œæ‹¿åˆ°è¿™ä¸ªulçš„åˆ—è¡¨ä¹‹åxpathå¾—åˆ°çš„æ˜¯ä¸‹é¢æ‰€æœ‰çš„å…ƒç´ èŠ‚ç‚¹çš„SelectorListå¯¹è±¡ï¼ŒåŒ…å«å­èŠ‚ç‚¹çš„seector,å¯ä»¥å…ˆè°ƒç”¨
å±æ€§åƒè¿™æ ·<br></p> <div align="center"><img src="/assets/img/selectorpro.996d84f7.png" style="height:440px"></div>
ä¸Šé¢çš„ä¸‹åˆ’çº¿å¼€å¤´çš„æ˜¯metaå±æ€§æœ€å¥½ä¸è¦è¿›è¡Œæ“ä½œï¼Œselectorçš„attr['pros']ç›´æ¥è·å–å¯¹è±¡çš„å±æ€§
<div align="center"><img src="/assets/img/selector.7e29119d.png" style="height:440px"></div>
selectorå¯ä»¥ç»§ç»­è°ƒç”¨csså’Œxpathå¦‚ä¸Šå›¾
<div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>urllib.parse import urljoin<br>
pageurl=urljoin(base=&quot;https://www.jianshu.com&quot;,url=i.attrib[&quot;href&quot;])<br>
urljoinå¯ä»¥æŠŠurlå’ŒåŸŸåè¿æ¥èµ·æ¥ï¼Œä¿è¯ä¸ä¼šå‡ºé”™</p></div> <h3 id="ä½¿ç”¨itemloader"><a href="#ä½¿ç”¨itemloader" aria-hidden="true" class="header-anchor">#</a> ä½¿ç”¨Itemloader</h3> <h4>ä½¿ç”¨itemloaderä¾¿äºç»´æŠ¤</h4> <p>from scrapy.loader import ItemLoader<br>
åŒæ ·ï¼Œä½ éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªItem
item=ItemLoader(item=JianshuItem(),response=response)<br>
æŠŠè‡ªå·±å¯¼å…¥çš„itemå’Œå‡½æ•°æ¥å—å¾—åˆ°çš„responseä¼ ç»™å®ƒ
æ¥ä¸‹æ¥ä½ å¯ä»¥æ·»åŠ å±æ€§
ä¸»è¦ç”¨</p> <ul><li>item.add_xpath('FieldName','ä¸€ä¸ªxpath')</li> <li>item.add_css('FieldName','ä¸€ä¸ªcssselector')</li> <li>item.add_value('FieldName',éšä¾¿ä»€ä¹ˆå˜é‡)
æœ€åè®°å¾—return item.load_load()å‡ºå»</li></ul> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">def</span> <span class="token function">parse_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>response<span class="token punctuation">)</span><span class="token punctuation">:</span>
    item<span class="token operator">=</span>ItemLoader<span class="token punctuation">(</span>item<span class="token operator">=</span>JianshuItem<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>response<span class="token operator">=</span>response<span class="token punctuation">)</span>
    item<span class="token punctuation">.</span>add_xpath<span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span><span class="token string">'/html/body/div[1]/div[2]/div[1]/h1/text()'</span><span class="token punctuation">)</span>
    item<span class="token punctuation">.</span>add_value<span class="token punctuation">(</span><span class="token string">'likes'</span><span class="token punctuation">,</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">'&lt;script type=&quot;application/json&quot; data-name=&quot;page-data&quot;&gt;(.*?)&lt;/script&gt;'</span><span class="token punctuation">,</span>response<span class="token punctuation">.</span>body<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    item<span class="token punctuation">.</span>add_css<span class="token punctuation">(</span><span class="token string">'author'</span><span class="token punctuation">,</span><span class="token string">'body &gt; div.note &gt; div.post &gt; div.article &gt; div.author &gt; div &gt; span &gt; a::text'</span><span class="token punctuation">)</span>
    item<span class="token punctuation">.</span>add_value<span class="token punctuation">(</span><span class="token string">'noteid'</span><span class="token punctuation">,</span>response<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    item<span class="token punctuation">.</span>add_value<span class="token punctuation">(</span><span class="token string">'imageurl'</span><span class="token punctuation">,</span>response<span class="token punctuation">.</span>meta<span class="token punctuation">[</span><span class="token string">'imageurl'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> item<span class="token punctuation">.</span>load_item<span class="token punctuation">(</span><span class="token punctuation">)</span>


</code></pre></div><div class="danger custom-block"><p class="custom-block-title">æ³¨æ„</p> <p>item_loaderå’Œextracté»˜è®¤å§itemèµ‹å€¼éƒ½æ˜¯ä»¥listçš„å½¢å¼</p></div> <h3>ç®€ä¹¦åˆ†æ</h3> <p>ç®€ä¹¦è¿™æ ·çš„ç½‘ç«™æ–‡ç« æ˜¯htmlé‡Œé¢ç›´æ¥å­˜åœ¨çš„ï¼Œè€Œä¸‹é¢çš„ä½œè€…ï¼Œè¯„è®ºï¼Œå–œæ¬¢æ‰“èµæ˜¯jsåŠ è½½å‡ºæ¥çš„
ç›´æ¥è·å–xpathå’Œcssselectoræ˜¯ä¸è¡Œçš„
</p><div align="center"><img src="/assets/img/delete.bfd37baa.png" style="height:340px"></div> <h4>å»æ‰è¿™å‡ ä¸ªjsåä¼šè¿™æ ·</h4><p></p> <div align="center"><img src="/assets/img/effect.1871cfca.png" style="height:340px"></div> <p>æ•°æ®æ˜¯éšç€htmlä¸­çš„ä¸€ä¸ª&lt;script type=&quot;application/json&quot; data-name=&quot;page-data&quot;&gt;æ¥çš„</p> <div align="center"><img src="/assets/img/datasource.6688db05.png" style="height:340px"></div> <p>ç”¨æ­£åˆ™åŒ¹é…åˆ°è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œåœ¨piplineä¸­æ‹¿å‡ºæˆ‘ä»¬æƒ³è¦çš„æ•°æ®å³å¯</p> <h2 id="item"><a href="#item" aria-hidden="true" class="header-anchor">#</a> Item</h2> <h3 id="å®šä¹‰itemçš„filed"><a href="#å®šä¹‰itemçš„filed" aria-hidden="true" class="header-anchor">#</a> å®šä¹‰itemçš„Filed</h3> <p>Itemå®šä¹‰åœ¨items.pyé‡Œé¢ä¸€èˆ¬è¿™ä¸ªå­—æ®µæ˜¯ä½ æƒ³å¯¹åº”åˆ°dbé‡Œé¢çš„å­—æ®µ,ç”¨scrapy.Field()æ¥å®šä¹‰,åœ¨spiderä¸­èµ‹å€¼çš„æ—¶å€™å°±å¯ä»¥åƒç»™å­—å…¸èµ‹å€¼ä¸€æ ·ç›´æ¥èµ‹å€¼
åªæœ‰è¢«å®šä¹‰çš„å­—æ®µæ‰å¯ä»¥è¢«èµ‹å€¼ã€‚
å¯ä»¥åšä¸€äº›å¤„ç†å¤„ç†è¿‡åæ‰æ”¾åˆ°piplinesä¸­å»<br></p> <div align="center"><img src="/assets/img/items.83d443a9.png" style="height:340px"></div> <h3 id="è¾“å…¥è¾“å‡ºå¤„ç†å™¨"><a href="#è¾“å…¥è¾“å‡ºå¤„ç†å™¨" aria-hidden="true" class="header-anchor">#</a> è¾“å…¥è¾“å‡ºå¤„ç†å™¨</h3> <p>åœ¨Fieldä¸­å¯ä»¥å®šä¹‰è¾“å…¥å¤„ç†å’Œè¾“å‡ºå¤„ç†å™¨(å°±æ˜¯ç”Ÿå‘½å‘¨æœŸé’©å­)ï¼ŒæŒ‡å®šä¸€ä¸ªå‡½æ•°ï¼Œ
å½“itemè¢«returnçš„æ—¶å€™å…ˆè°ƒç”¨è¾“å…¥å†è°ƒç”¨è¾“å‡ºå¤„ç†å¯¹å­—æ®µåŠ å·¥ç„¶åç»™pipline
æ˜¯åœ¨returnçš„æ—¶å€™æ‰ä¼šè¿›è¡Œ<br>
é»˜è®¤çš„æœ‰å‡ ç§processorï¼Œå¯ä»¥å®šä¹‰ä¸€ä¸ªå‡½æ•°ç”¨MapComposeè‡ªå·±æ·»åŠ <br>
SelectJmesï¼ŒIdentityï¼ŒTakeFirstï¼ŒComposeï¼ŒMapCompose
<br></p> <p>input_processor=MapCompose(ä¸€ä¸ªåŒ¿åå‡½æ•°),<br>
output_processor=TakeFirst(),<br>
è¿™é‡Œçš„å€¼æ²¡æœ‰å˜ï¼Œç”¨ä¸€ä¸ªåŒ¿åå‡½æ•°åˆæ­¥å¤„ç†ä¸€ä¸‹æƒ³è¦ç›´æ¥å¤„ç†æ¸…æ¥šå¯ä»¥ç›´æ¥ç”¨pipline</p> <div class="language-py extra-class"><pre class="language-py"><code>
<span class="token keyword">def</span> <span class="token function">callme</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;æˆ‘è¢«è°ƒç”¨å•¦&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> value

<span class="token keyword">class</span> <span class="token class-name">JianshuItem</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Item<span class="token punctuation">)</span><span class="token punctuation">:</span>

    title<span class="token operator">=</span>scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    likes<span class="token operator">=</span>scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span>
        output_processor<span class="token operator">=</span>MapCompose<span class="token punctuation">(</span>callme<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#æŠŠè¿™ä¸ªé‡Œé¢çš„ä¸œè¥¿å‡ºæ¥</span>
    author<span class="token operator">=</span>scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    imageurl<span class="token operator">=</span>scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span>
        input_processor<span class="token operator">=</span>MapCompose<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token string">&quot;http:&quot;</span><span class="token operator">+</span>x<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    noteid<span class="token operator">=</span>scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><h3 id="django-scrapy-item"><a href="#django-scrapy-item" aria-hidden="true" class="header-anchor">#</a> django scrapy item</h3> <div class="danger custom-block"><p class="custom-block-title">ç•™å‘</p> <p>å†™ç®€ä¹¦çš„æ—¶å€™è¯•è¯•</p></div> <h2 id="pipline"><a href="#pipline" aria-hidden="true" class="header-anchor">#</a> Pipline</h2> <p>é¦–å…ˆåœ¨settingä¸­å¼€å¯piplineå–æ¶ˆITEM_PIPELINESçš„æ³¨é‡Š
è¿™ä¸ªå­—å…¸ä¸€æ ·çš„ç»“æ„æ˜¯æµç»é¡ºåº,æ•°å­—è¶Šå°è¿™ä¸ªpiplineä¼šå…ˆæµç»,itemå°±åƒæµç»ç®¡é“ä¸€æ ·ä¸€ä¸ªä¸€ä¸ªæµè¿‡piplineä¼šå–ä¸‹æˆ–è€…ä¿®æ”¹itemçš„å­—æ®µ,å­˜å…¥sqlæˆ–whateverç„¶åreturnå‡ºå»
è®©ä»–æµç»ä¸‹ä¸€ä¸ªpiplineåƒè¿™æ ·</p> <div class="language-py extra-class"><pre class="language-py"><code>ITEM_PIPELINES <span class="token operator">=</span> <span class="token punctuation">{</span>
   <span class="token string">'aa.pipelines.likesPipeline'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
   <span class="token string">'aa.pipelines.SqlPipeline'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

</code></pre></div><h3>å®šä¹‰process_item</h3> <p>é»˜è®¤æ¥å—ä¸€ä¸ªitemå’Œä¸€ä¸ªspiderï¼Œitemå°±æ˜¯ä½ åœ¨itemä¸­å®šä¹‰çš„,åƒè°ƒç”¨å­—å…¸ä¸€æ ·è°ƒç”¨item
æŒ‰ç…§ä¸Šé¢è¯´çš„é¡ºåºæœ€ååˆ«å¿˜äº†returnå‡ºå»ç»™ä¸‹ä¸€ä¸ªpipelineç”¨</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">class</span> <span class="token class-name">MyPipline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    process_item<span class="token punctuation">(</span>self<span class="token punctuation">,</span> item<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token keyword">return</span> item
</code></pre></div><p>åƒå–å­—å…¸ä¸€æ ·ç›´æ¥å–ç„¶åèµ‹å€¼å°±å¯ä»¥äº†
å…ˆç»è¿‡äº†likespipelineï¼Œæ‹¿å‡ºè¿™ä¸ªå­—ç¬¦ä¸²æˆ‘ä»¬æƒ³è¦çš„éƒ¨åˆ†(åšå¤„ç†)ï¼Œç„¶åæµåˆ°äº†SqlPipelineè¢«æ‰“å°äº†å‡ºæ¥
</p><div align="center"><img src="/assets/img/pipeline.72f215ff.png" style="height:440px"></div><p></p> <h3 id="å›¾ç‰‡pipeline"><a href="#å›¾ç‰‡pipeline" aria-hidden="true" class="header-anchor">#</a> å›¾ç‰‡Pipeline</h3> <p>å¾ˆå¤šæƒ…å†µä¸‹æ˜¯ä¸‰ç§æœ€å¸¸ç”¨çš„media,file,imageæœ‰å¯¹åº”å†™å¥½çš„piplineå†…ç½®å¼•å…¥</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token comment">#piplinesæ–‡ä»¶ä¸­å¼•å…¥</span>
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>pipelines<span class="token punctuation">.</span>images <span class="token keyword">import</span> ImagesPipeline

settingä¸­æŒ‡æ˜ä¸¤ä¸ªå˜é‡
IMAGES_URLS_FIELD <span class="token operator">=</span> <span class="token string">&quot;imageurl&quot;</span><span class="token comment">#å“ªä¸ªå­—æ®µæ˜¯imageçš„url</span>
IMAGES_STORE <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>project_dir<span class="token punctuation">,</span><span class="token string">&quot;image&quot;</span><span class="token punctuation">)</span><span class="token comment">#å­˜åœ¨å“ªä¸ªè·¯å¾„ä¸‹</span>
æ·»åŠ è¿›piplinesä¸­
ITEM_PIPELINES <span class="token operator">=</span> <span class="token punctuation">{</span>
<span class="token string">'scrapy.pipelines.images.ImagesPipeline'</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token comment">#æ™®é€šçš„å›¾ç‰‡pipeline</span>
                  <span class="token punctuation">}</span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p> <p>è¿™ä¸ªimageurlåº”è¯¥æ˜¯ä¸ªåˆ—è¡¨å½¢å¼,ä¸è¦å–å‡ºæ¥ä¼šæŠ¥é”™</p></div> <h4>è‡ªå®šä¹‰å­˜æ”¾è·¯å¾„çš„imagepipline</h4> <br> <p>é¦–å…ˆå¼•å…¥å¹¶ç»§æ‰¿ImagesPipeline
é‡å†™def item_completed(self, results, item, info)
<br>è‡ªå·±æ‰“æ–­ç‚¹çœ‹é‡Œé¢çš„å˜é‡,æ”¹å˜æƒ³è¦çš„å˜é‡å³å¯</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">class</span> <span class="token class-name">JobboleImagePipline</span><span class="token punctuation">(</span>ImagesPipeline<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#è‡ªå®šä¹‰çš„ç®¡é“è¿›è¡Œè·¯å¾„å­˜æ”¾</span>
    <span class="token keyword">def</span> <span class="token function">item_completed</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> results<span class="token punctuation">,</span> item<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> status<span class="token punctuation">,</span>p <span class="token keyword">in</span> results<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                item<span class="token punctuation">[</span><span class="token string">&quot;imagepath&quot;</span><span class="token punctuation">]</span><span class="token operator">=</span>p<span class="token punctuation">[</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">]</span>
                item<span class="token punctuation">[</span><span class="token string">&quot;imageurl&quot;</span><span class="token punctuation">]</span><span class="token operator">=</span>item<span class="token punctuation">[</span><span class="token string">&quot;imageurl&quot;</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword">except</span> TypeError<span class="token punctuation">:</span>
                item<span class="token punctuation">[</span><span class="token string">&quot;imageurl&quot;</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">&quot;None&quot;</span>
                item<span class="token punctuation">[</span><span class="token string">&quot;imagepath&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;None&quot;</span>
        <span class="token keyword">return</span> item
</code></pre></div><h3 id="æ’å…¥sqlæ•°æ®åº“"><a href="#æ’å…¥sqlæ•°æ®åº“" aria-hidden="true" class="header-anchor">#</a> æ’å…¥sqlæ•°æ®åº“</h3> <p>åœ¨è¿™ä¸ªå‡½æ•°é‡Œå–å‡ºå€¼ç„¶åå­˜è¿›å»ä¾‹å­</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">class</span> <span class="token class-name">SqlPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#æ„é€ sqlè¯­å¥å¹¶æ‰§è¡Œå³å¯</span>
    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>item<span class="token punctuation">,</span>spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''item={'author': ['åŸåŒ—å¬é›ª'],
        'imageurl': ['http://upload-images.jianshu.io/upload_images/14074951-f700da6a9b168924.jpg'],
        'likes': ['33'],
        'noteid': ['https://www.jianshu.com/p/3e652aafb69b'],
        'title': ['5å¤©æµæµªåŠ å¾·æ»¡éƒ½ï¼Œç»™ä½ çœ‹ä¸€ä¸ªä¸ä¸€æ ·çš„çœŸå®å°¼æ³Šå°”']}'''</span>
        a<span class="token operator">=</span><span class="token punctuation">{</span> k<span class="token punctuation">:</span>v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span>v <span class="token keyword">in</span> item<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">#æ„é€ å­—ç¬¦ä¸²</span>
        str1 <span class="token operator">=</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> a<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        str2 <span class="token operator">=</span> <span class="token string">&quot;','&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> a<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        sql<span class="token operator">=</span><span class="token string">&quot;INSERT INTO jianshu ({0}) VALUES ('{1}')&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>str1<span class="token punctuation">,</span>str2<span class="token punctuation">)</span><span class="token comment">#æ„é€ sql</span>
        conn<span class="token operator">=</span>pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span>port<span class="token operator">=</span><span class="token number">3306</span><span class="token punctuation">,</span>user<span class="token operator">=</span><span class="token string">'root'</span><span class="token punctuation">,</span>db<span class="token operator">=</span><span class="token string">'jobol'</span><span class="token punctuation">,</span>password<span class="token operator">=</span><span class="token string">'ä¸å‘Šè¯‰ä½ '</span><span class="token punctuation">,</span>charset<span class="token operator">=</span><span class="token string">'utf8mb4'</span><span class="token punctuation">)</span>
        cur<span class="token operator">=</span>conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
            conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            conn<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            cur<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> item

</code></pre></div><p>æ‰“å°å‡ºæ¥çš„sqlåº”è¯¥åƒè¿™æ ·</p> <pre><code>  INSERT INTO jianshu
  (author,imageurl,likes,noteid,title)
  VALUES
  ('åŸåŒ—å¬é›ª','http://upload-images.jianshu.io/upload_images/14074951-f700da6a9b168924.jpg','33','https://www.jianshu.com/p/3e652aafb69b','5å¤©æµæµªåŠ å¾·æ»¡éƒ½ï¼Œç»™ä½ çœ‹ä¸€ä¸ªä¸ä¸€æ ·çš„çœŸå®å°¼æ³Šå°”')
</code></pre> <h3 id="å¼‚æ­¥æ’å…¥sql"><a href="#å¼‚æ­¥æ’å…¥sql" aria-hidden="true" class="header-anchor">#</a> å¼‚æ­¥æ’å…¥sql</h3> <p>é¦–å…ˆå®šä¹‰æ–°çš„piplineï¼Œç„¶åå¼€å§‹ç¼–å†™å¼‚æ­¥æ’å…¥çš„pipline
éœ€è¦pywin32,twisted<br></p><h4>å†™æ³•å¾ˆå›ºå®šï¼Œè®°ä½æ€ä¹ˆå†™ç†è§£è¿™æ˜¯åšä»€ä¹ˆçš„</h4><p></p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">import</span> pymysql
<span class="token keyword">from</span> twisted<span class="token punctuation">.</span>enterprise <span class="token keyword">import</span> adbapi
<span class="token keyword">import</span> pymysql<span class="token punctuation">.</span>cursors
<span class="token comment">#å…ˆå¼•å…¥</span>

<span class="token keyword">class</span> <span class="token class-name">asyPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>dbpool<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#é»˜è®¤ä¼ å…¥ä¸€ä¸ªè¿æ¥æ± </span>
        self<span class="token punctuation">.</span>dbpool<span class="token operator">=</span>dbpool

    @<span class="token builtin">classmethod</span><span class="token comment">#å£°æ˜ä¸€ä¸ªç±»æ–¹æ³•</span>
    <span class="token keyword">def</span> <span class="token function">from_settings</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span>settings<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment">#æ³¨æ„æ˜¯settingsæœ‰Sè¿™ä¸ªç±»æ–¹æ³•å’Œå®ä¾‹æ²¡æœ‰å…³ç³»,æ¥å—ä¸€ä¸ªsettingä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶</span>
    <span class="token comment">#æŠŠå˜é‡æ‹¿è¿‡æ¥ï¼Œä¼ å…¥adbpoolé‡Œé¢å®šä¹‰ä¸€ä¸ªdbpool</span>
        dbpool<span class="token operator">=</span>adbapi<span class="token punctuation">.</span>ConnectionPool<span class="token punctuation">(</span><span class="token string">'pymysql'</span><span class="token punctuation">,</span>
                                     host<span class="token operator">=</span>settings<span class="token punctuation">[</span><span class="token string">'MYSQL_HOST'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                     db<span class="token operator">=</span>settings<span class="token punctuation">[</span><span class="token string">'DB_NAME'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                     user<span class="token operator">=</span>settings<span class="token punctuation">[</span><span class="token string">'MYSQL_USER'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                     password<span class="token operator">=</span>settings<span class="token punctuation">[</span><span class="token string">'MYSQL_PASSWOED'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                     charset<span class="token operator">=</span>settings<span class="token punctuation">[</span><span class="token string">'CHARSET'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                                     cursorclass<span class="token operator">=</span>pymysql<span class="token punctuation">.</span>cursors<span class="token punctuation">.</span>DictCursor<span class="token punctuation">,</span>
                                     use_unicode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token comment">#è¿™é‡Œå¯ä»¥å†™æ­»ä¹Ÿå¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•è¯»å–settingé‡Œé¢çš„é…ç½®ä¿¡æ¯(å»ºè®®)</span>
        <span class="token keyword">return</span> cls<span class="token punctuation">(</span>dbpool<span class="token operator">=</span>dbpool<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>item<span class="token punctuation">,</span>spider<span class="token punctuation">)</span><span class="token punctuation">:</span>

        query<span class="token operator">=</span>self<span class="token punctuation">.</span>dbpool<span class="token punctuation">.</span>runInteraction<span class="token punctuation">(</span>self<span class="token punctuation">.</span>do_insert<span class="token punctuation">,</span> item<span class="token punctuation">)</span>
        <span class="token comment">#æ‰§è¡Œï¼Œç›¸å½“äºloopå¯åŠ¨ï¼Œå®šä¹‰ä¸€ä¸ªå˜é‡æ¥ä»£è¡¨</span>
        query<span class="token punctuation">.</span>addErrback<span class="token punctuation">(</span>self<span class="token punctuation">.</span>handler<span class="token punctuation">)</span>
        <span class="token comment">#åˆ¶å®šé”™è¯¯å¤„ç†å‡½æ•°</span>

    <span class="token keyword">def</span> <span class="token function">do_insert</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>cursor<span class="token punctuation">,</span>item<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''æ‰§è¡ŒæŸ¥è¯¢çš„å‡½æ•°'''</span>
        a <span class="token operator">=</span> <span class="token punctuation">{</span>k<span class="token punctuation">:</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> item<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>  <span class="token comment"># æ„é€ å­—ç¬¦ä¸²</span>
        str1 <span class="token operator">=</span> <span class="token string">&quot;,&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> a<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        str2 <span class="token operator">=</span> <span class="token string">&quot;','&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>i <span class="token keyword">for</span> i <span class="token keyword">in</span> a<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        sql <span class="token operator">=</span> <span class="token string">&quot;INSERT INTO jianshu ({0}) VALUES ('{1}')&quot;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>str1<span class="token punctuation">,</span> str2<span class="token punctuation">)</span>  <span class="token comment"># æ„é€ sql</span>
        cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>

        <span class="token comment">#ä¸èƒ½ç”¨tryå¼‚æ­¥æ²¡æœ‰try</span>
    <span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>failure<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#å®šä¹‰é”™è¯¯å¤„ç†</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>failure<span class="token punctuation">)</span><span class="token comment">#æ‰“å°é”™è¯¯</span>



</code></pre></div><div class="danger custom-block"><p class="custom-block-title">æ³¨æ„</p> <p>ä¸èƒ½ç”¨tryï¼Œå¼‚æ­¥é‡Œé¢æ²¡æœ‰try</p></div> <h3 id="æ’å…¥mongo"><a href="#æ’å…¥mongo" aria-hidden="true" class="header-anchor">#</a> æ’å…¥mongo</h3> <h3 id="ä¿å­˜ä¸ºjson"><a href="#ä¿å­˜ä¸ºjson" aria-hidden="true" class="header-anchor">#</a> ä¿å­˜ä¸ºjson</h3> <div class="language-py extra-class"><pre class="language-py"><code>
<span class="token keyword">class</span> <span class="token class-name">JsonPipeline</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_item</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>item<span class="token punctuation">,</span>spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        a <span class="token operator">=</span> <span class="token punctuation">{</span>k<span class="token punctuation">:</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> item<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">#æ ¼å¼åŒ–ä¸€ä¸‹</span>
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">r'jianshu.json'</span><span class="token punctuation">,</span><span class="token string">'a'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>a<span class="token punctuation">,</span>f<span class="token punctuation">,</span>ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
</code></pre></div><div align="center"><img src="/assets/img/cunchu.88c7cd3e.png" style="height:440px"></div> <h2 id="middleware"><a href="#middleware" aria-hidden="true" class="header-anchor">#</a> Middleware</h2> <p>æ˜¯ä¸€ä¸ªé’©å­ç³»ç»Ÿï¼Œæ³¨å…¥åˆ°ç”Ÿå‘½å‘¨æœŸä¸­å¯æ‰©å±•æ€§å¥½
donwloader middlewaerç”¨å¾—æœ€å¤šï¼Œ
spidermiddlewareæ²¡æ€ä¹ˆç”¨
æ¯æ¬¡çˆ¬çš„æ—¶å€™ç»è¿‡ä¸€æ¬¡ä¸­é—´ä»¶,åƒpiplineä¸€æ ·æµè¿‡æœ€ååœ¨è¿›è¡Œè¯·æ±‚<br>
ä¸»è¦ä½œç”¨æ›´æ¢ä»£ç†IPï¼Œæ›´æ¢Cookiesï¼Œæ›´æ¢User-Agentï¼Œè‡ªåŠ¨é‡è¯•
</p><h4>é‡å†™process_request</h4>(self,request,spider):<p></p> <h3 id="éšæœºuser-agent"><a href="#éšæœºuser-agent" aria-hidden="true" class="header-anchor">#</a> éšæœºUser-Agent</h3> <p>å¯ä»¥åœ¨settingé‡Œé¢åˆ¶å®šUA<br> <em>USER_AGENT = 'Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.36'</em>
æ‰€æœ‰çš„éƒ½ä¼šç”¨è¿™ä¸ªUA<br></p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">import</span> fake_useragent
<span class="token keyword">class</span> <span class="token class-name">RandomUAMiddleware</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>request<span class="token punctuation">,</span>spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        ua<span class="token operator">=</span>fake_useragent<span class="token punctuation">.</span>UserAgent<span class="token punctuation">(</span><span class="token punctuation">)</span>
        request<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">'User-Agent'</span><span class="token punctuation">,</span>ua<span class="token punctuation">.</span>random<span class="token punctuation">)</span>
</code></pre></div><p>ç½‘ä¸Šå¾ˆå¤šç”¨UAlistçš„ï¼ŒåŸºæœ¬å°±æ˜¯importä¸€ä¸‹ï¼Œç„¶årandomå–ä¸€ä¸‹<br></p> <h4>fake_uaäº†è§£ä¸€ä¸‹ï¼Ÿ</h4>
gitæœæ‰€ç¬¬ä¸€ä¸ªå°±æ˜¯ï¼Œå¯ä»¥ç›´æ¥pipå®‰è£…<br> <p>åŸºæœ¬ä½¿ç”¨</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">from</span> fake_useragent <span class="token keyword">import</span> UserAgent
ua <span class="token operator">=</span> UserAgent<span class="token punctuation">(</span><span class="token punctuation">)</span>
ua<span class="token punctuation">.</span>random<span class="token comment">#ç›´æ¥éšæœºè¿”å›ä¸€ä¸ªå¤´</span>
ua<span class="token punctuation">.</span>ie<span class="token comment">#è¿”å›ieçš„å¤´</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">å¯ç”¨çš„å¤´</p> <p>ie,msie,opera,chrome,google,firefox,ff,safari</p></div> <h3 id="ipä»£ç†"><a href="#ipä»£ç†" aria-hidden="true" class="header-anchor">#</a> IPä»£ç†</h3> <p>åŒæ ·æ˜¯æ“ä½œreuestçš„metaä¿¡æ¯</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">import</span> random
<span class="token comment">#from settings import IPpool</span>
<span class="token keyword">class</span> <span class="token class-name">IPproxyMiddleware</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''å¼•å…¥ä¸€ä¸ªipæ± æˆ–è¯·æ±‚ä¸€æ¬¡(è´­ä¹°çš„)æ¥å£,éšæœºé€‰æ‹©ä¸€ä¸ªipå°±å¯ä»¥'''</span>
        request<span class="token punctuation">.</span>meta<span class="token punctuation">[</span><span class="token string">&quot;proxy&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;https://222.223.115.30:51618&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="ä½¿ç”¨cookie"><a href="#ä½¿ç”¨cookie" aria-hidden="true" class="header-anchor">#</a> ä½¿ç”¨cookie</h3> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">class</span> <span class="token class-name">cookieMiddleware</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>request<span class="token punctuation">,</span>spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        request<span class="token punctuation">.</span>cookies <span class="token operator">=</span><span class="token string">'é€šè¿‡æ¥å£æˆ–ä»€ä¹ˆæ–¹å¼æ‹¿åˆ°ä½ çš„cookie'</span>

    <span class="token keyword">def</span> <span class="token function">process_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
        å¯¹æ­¤æ¬¡å“åº”è¿›è¡Œå¤„ç†
        å¦‚æœè¯·æ±‚ä¸æˆåŠŸæ€ä¹ˆå¤„ç†
        å¦‚æœcookieå¤±æ•ˆæ€ä¹ˆåŠ
        '''</span>
        <span class="token keyword">pass</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>æœ€å¥½è‡ªå·±æ­å»ºä»£ç†æ± å’Œcookieæ± ï¼Œç”¨çš„æ—¶å€™ç›´æ¥è°ƒç”¨æ¥å£
<br>åç»­æˆ‘åœ¨å‡ºè¿™ä¸ª</p></div> <div class="warning custom-block"><p class="custom-block-title">WARNING</p> <p>è¯·æ±‚å¤´æºå¸¦çš„Cookieå¿…é¡»æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œä¸èƒ½ç›´æ¥è®¾ç½®æˆå­—ç¬¦ä¸²</p></div> <h3 id="è‡ªåŠ¨é‡è¯•ä¸­é—´ä»¶"><a href="#è‡ªåŠ¨é‡è¯•ä¸­é—´ä»¶" aria-hidden="true" class="header-anchor">#</a> è‡ªåŠ¨é‡è¯•ä¸­é—´ä»¶</h3> <p>settingçš„dowloadermiddlwareä¸­<br> <em>scrapy.downloadermiddlewares.retry.RetryMiddleware:6</em></p><h4>ç›¸å…³è®¾ç½®</h4><br><p></p> <ul><li><p>RETRY_ENABLED: æ˜¯å¦å¼€å¯retry(True)</p></li> <li><p>RETRY_TIMES: é‡è¯•æ¬¡æ•°(3)</p></li> <li><p>RETRY_HTTP_CODECS: é»˜è®¤[500,502,503,504,408]</p></li></ul> <h3 id="é›†æˆselenium"><a href="#é›†æˆselenium" aria-hidden="true" class="header-anchor">#</a> é›†æˆselenium</h3> <p>seleniumå¯ä»¥ç›´æ¥åœ¨ä¸­é—´ä»¶ç›´æ¥å†™</p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">class</span> <span class="token class-name">seleniumMiddleware</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>broswer <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>executable_path<span class="token operator">=</span><span class="token string">r'D:\57635\chromedriver.exe'</span><span class="token punctuation">)</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>request<span class="token punctuation">,</span>spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> spider<span class="token punctuation">.</span>name<span class="token operator">==</span><span class="token string">'jianshu'</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>broswer<span class="token punctuation">.</span>get<span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'seleniumè®¿é—®{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token keyword">return</span> HtmlResponse<span class="token punctuation">(</span>url<span class="token operator">=</span>self<span class="token punctuation">.</span>broswer<span class="token punctuation">.</span>current_url<span class="token punctuation">,</span>
                                body<span class="token operator">=</span>self<span class="token punctuation">.</span>broswer<span class="token punctuation">.</span>page_source<span class="token punctuation">,</span>
                                encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span>
                                request<span class="token operator">=</span>request<span class="token punctuation">)</span>

</code></pre></div><p>ä½†æ˜¯å½“ä¸€ä¸ªspiderç»“æŸçš„æ—¶å€™æµè§ˆå™¨ä¹Ÿä¸ä¼šé€€å‡ºï¼Œè¿™æ ·å¯¼è‡´æ¶ˆè€—èµ„æº
</p><h4>åœ¨spiderä¸­æ˜¯ç›´æ¥å†™</h4>
åœ¨spiderä¸­æ·»åŠ <p></p> <div class="language-py extra-class"><pre class="language-py"><code><span class="token keyword">from</span> selenium <span class="token keyword">import</span> webdriver
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>xlib<span class="token punctuation">.</span>pydispatch <span class="token keyword">import</span> dispatcher
<span class="token keyword">from</span> scrapy <span class="token keyword">import</span> signals

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>broswer <span class="token operator">=</span> webdriver<span class="token punctuation">.</span>Chrome<span class="token punctuation">(</span>executable_path<span class="token operator">=</span><span class="token string">r'D:\57635\chromedriver.exe'</span><span class="token punctuation">)</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        dispatcher<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>self<span class="token punctuation">.</span>spider_closed<span class="token punctuation">,</span>signals<span class="token punctuation">.</span>spider_closed<span class="token punctuation">)</span><span class="token comment">#ä¿¡å·é‡</span>

    <span class="token keyword">def</span> <span class="token function">spider_closed</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;å®Œæˆ&quot;</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>broswer<span class="token punctuation">.</span>quit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#é€€å‡º</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

middlware<span class="token punctuation">:</span>
<span class="token keyword">import</span> time
<span class="token keyword">from</span> scrapy<span class="token punctuation">.</span>http <span class="token keyword">import</span> HtmlResponse
<span class="token keyword">class</span> <span class="token class-name">seleniumMiddleware</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">process_request</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>request<span class="token punctuation">,</span>spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> spider<span class="token punctuation">.</span>name<span class="token operator">==</span><span class="token string">'jianshu'</span><span class="token punctuation">:</span>
            spider<span class="token punctuation">.</span>broswer<span class="token punctuation">.</span>get<span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'seleniumè®¿é—®{}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token keyword">return</span> HtmlResponse<span class="token punctuation">(</span>url<span class="token operator">=</span>spider<span class="token punctuation">.</span>broswer<span class="token punctuation">.</span>current_url<span class="token punctuation">,</span>
                                body<span class="token operator">=</span>spider<span class="token punctuation">.</span>broswer<span class="token punctuation">.</span>page_source<span class="token punctuation">,</span>
                                encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">,</span>
                                request<span class="token operator">=</span>request<span class="token punctuation">)</span>

</code></pre></div><p>è§£é‡Šä¸€ä¸‹ï¼Œè¿™é‡Œå¼•å…¥çš„æ˜¯dispatchå’Œä¿¡å·signalï¼Œsignalæ˜¯scrapyå„ç§å¯¹è±¡ç”Ÿå‘½å‘¨æœŸä¿¡å·ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå†™çš„æ˜¯å½“ä¸€ä¸ªçˆ¬è™«ç»“æŸçš„æ—¶å€™æ‰§è¡Œself.spider_closedå‡½æ•°ï¼Œå’Œä¿¡å·ç»‘ä¸Šï¼Œè¿™é‡Œå’Œdjangoé‡Œé¢çš„ä¿¡å·å¾ˆåƒ
åé¢å†è®²
è¿™æ ·åœ¨ä¸€ä¸ªspiderç»“æŸçš„æ—¶å€™å°±ä¼šé€€å‡ºæµè§ˆå™¨</p> <h2 id="schduler-other"><a href="#schduler-other" aria-hidden="true" class="header-anchor">#</a> Schduler&amp;Other</h2> <h3 id="schdulerå»é‡æœºåˆ¶"><a href="#schdulerå»é‡æœºåˆ¶" aria-hidden="true" class="header-anchor">#</a> Schdulerå»é‡æœºåˆ¶</h3> <p>Schduleræ˜¯ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œè¿™é‡Œé¢æ˜¯ä¸€äº›é˜Ÿåˆ—å­˜æ”¾äº†æ‰€æœ‰å¾…çˆ¬çš„å·²ç»çˆ¬äº†çš„ç­‰ç­‰ï¼Œæ•´ä¸ªæ¡†æ¶çš„é˜Ÿåˆ—éƒ½åœ¨è¿™é‡Œé¢,å»é‡å’Œåˆ†å¸ƒå¼å¼€å‘æ’ä»¶å¼€å‘çš„æ—¶å€™ä¼šç”¨åˆ°
åˆ©ç”¨setå»é‡</p> <div class="danger custom-block"><p class="custom-block-title">ç•™å‘</p> <p>çœ‹æºç ä¹‹åå†å†™</p></div></div> <!----> <!----> <!----> <div class="page-edit" data-v-cdcae5a4><!----> <div class="last-updated" data-v-cdcae5a4><span class="prefix" data-v-cdcae5a4>Last Updated: </span> <span class="time" data-v-cdcae5a4>3/20/2020, 3:10:16 AM</span></div></div> <div class="page-nav" data-v-cdcae5a4><p class="inner" data-v-cdcae5a4><span class="prev" data-v-cdcae5a4>
        â†
        <a href="/blog/back/python/åŸºç¡€çˆ¬è™«.html" class="prev" data-v-cdcae5a4>
          åŸºç¡€çˆ¬è™«
        </a></span> <!----></p></div> </div> <div class="valine-wrapper" data-v-63f18ac0><div id="valine" style="display:;" data-v-63f18ac0></div></div> <!----> <!----> <div class="back-to-ceiling" style="right:1rem;bottom:3rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-41016a8b data-v-41016a8b><i class="iconfont reco-up" data-v-41016a8b></i></div></div></div></div>
    <script src="/assets/js/app.64171550.js" defer></script><script src="/assets/js/6.9305fa77.js" defer></script>
  </body>
</html>
